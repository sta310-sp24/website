{
  "hash": "5cf4939d15ae1c663d4d36b18e0e7e99",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"Poisson Regression\"\nsubtitle: \"Offset & Zero-inflated Poisson models\"\nauthor: \"Prof. Maria Tackett\"\ndate: \"2024-01-31\"\ndate-format: \"MMM DD, YYYY\"\nfooter: \"[üîó STA 310 - Spring 2024](https://sta310-sp24.netlify.app)\"\nlogo: \"../images/logo.png\"\nformat: \n  revealjs:\n    theme: slides.scss\n    slide-number: true\n    multiplex: false\n    transition: fade\n    incremental: false \n    chalkboard: true\nhtml-math-method:\n  method: mathjax\n  url: \"https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js\"\nexecute:\n  freeze: auto\n  echo: true\n  warning: false\n  message: false\nknitr:\n  opts_chunk: \n    R.options:      \n    width: 200\nbibliography: references.bib\n---\n\n\n\n::: {.cell layout-align=\"center\"}\n\n:::\n\n\n## Announcements\n\n-   Quiz 01 on Canvas due Thu, Feb 01 at noon\n\n-   HW 02 due Wed, Feb 07 at 11:59pm (grace period until Thu, Feb 08 noon)\n\n    -   Released tomorrow morning\n\n-   This week's lab: Project 01 article evaluation\n\n## Topics\n\n-   Offset in Poisson regression\n\n-   Zero-inflated Poisson regression\n\n# Offset\n\n## Data: Airbnbs in NYC {.small}\n\nThe data set [NYCairbnb-sample.csv](data/NYCairbnb-sample.csv) contains information about a random sample of 1000 Airbnbs in New York City. It is a subset of the data on 40628 Airbnbs scraped by @airbnb2017.[^1]\n\n[^1]: Data set pulled from [BMLR Section 4.11](https://bookdown.org/roback/bookdown-BeyondMLR/ch-poissonreg.html#exercises-3).\n\n**Variables**\n\n-   `number_of_reviews`: Number of reviews for the unit on Airbnb (proxy for number of rentals)\n-   `price`: price per night in US dollars\n-   `room_type`: Entire home/apartment, private room, or shared room\n-   `days`: Number of days the unit has been listed (date when info scraped - date when unit first listed on Airbnb)\n\n**Goal**: Use the price and room type of Airbnbs to describe variation in the number of reviews (a proxy for number of rentals).\n\n## Data: Airbnbs in NYC {.small}\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nairbnb <- read_csv(\"data/NYCairbnb-sample.csv\") \n```\n:::\n\n\n\\\n\n\n::: {.cell layout-align=\"center\"}\n::: {.cell-output-display}\n\n\n|       id| number_of_reviews| days|room_type       | price|\n|--------:|-----------------:|----:|:---------------|-----:|\n| 15756544|                16| 1144|Private room    |   120|\n| 14218251|                15|  471|Private room    |    89|\n|    21644|                 0| 2600|Private room    |    89|\n| 13667835|                 1|  283|Entire home/apt |   150|\n|   265912|                 0| 1970|Entire home/apt |    89|\n\n\n:::\n:::\n\n\n## EDA\n\n\n::: {.cell layout-align=\"center\"}\n::: {.cell-output-display}\n![](06-poisson-pt3_files/figure-revealjs/unnamed-chunk-4-1.png){fig-align='center' width=70%}\n:::\n:::\n\n\n## EDA\n\n::: columns\n::: {.column width=\"50%\"}\n<center><b>Overall</b></center>\n\n\n::: {.cell layout-align=\"center\"}\n::: {.cell-output-display}\n\n\n|   mean|     var|\n|------:|-------:|\n| 15.916| 765.969|\n\n\n:::\n:::\n\n:::\n\n::: {.column width=\"50%\"}\n<center><b>by room type</b></center>\n\n\n::: {.cell layout-align=\"center\"}\n::: {.cell-output-display}\n\n\n|room_type       |   mean|     var|\n|:---------------|------:|-------:|\n|Entire home/apt | 16.283| 760.348|\n|Private room    | 15.608| 786.399|\n|Shared room     | 15.028| 605.971|\n\n\n:::\n:::\n\n:::\n:::\n\n## Considerations for modeling\n\nWe would like to fit the Poisson regression model\n\n$$\\log(\\lambda_i) = \\beta_0 + \\beta_1 ~ price_i + \\beta_2 ~ room\\_type1_i + \\beta_3 ~ room\\_type2_i$$\n\n. . .\n\n::: question\n-   Based on the EDA, what are some potential issues we may want to address in the model building?\n\n-   Suppose any model fit issues are addressed. What are some potential limitations to the conclusions and interpretations from the model?\n:::\n\n\n::: {.cell layout-align=\"center\"}\n::: {.cell-output-display}\n\n```{=html}\n<div class=\"countdown\" id=\"timer_bef0771c\" data-update-every=\"1\" tabindex=\"0\" style=\"right:0;bottom:0;margin:5%;\">\n<div class=\"countdown-controls\"><button class=\"countdown-bump-down\">&minus;</button><button class=\"countdown-bump-up\">&plus;</button></div>\n<code class=\"countdown-time\"><span class=\"countdown-digits minutes\">02</span><span class=\"countdown-digits colon\">:</span><span class=\"countdown-digits seconds\">00</span></code>\n</div>\n```\n\n:::\n:::\n\n\n## Offset {.midi}\n\n-   Sometimes counts are not directly comparable because the observations differ based on some characteristic directly related to the counts, i.e. the *sampling effort*.\n\n-   An **offset** can be used to adjust for differences in sampling effort.\n\n. . .\n\n-   Let $x_{offset}$ be the variable that accounts for differences in sampling effort, then $\\log(x_{offset})$ will be added to the model.\n\n$$\\log(\\lambda_i) = \\beta_0 + \\beta_1 ~ x_{i1} + \\beta_2 ~ x_{i2} + ... + \\beta_p ~ x_{ip} + \\log(x_{offset_i})$$\n\n-   The offset is a term in the model with coefficient always equal to 1.\n\n## Adding an offset to the Airbnb model {.midi}\n\nWe will add the offset $\\log(days)$ to the model. This accounts for the fact that we would expect Airbnbs that have been listed longer to have more reviews.\n\n$$\\log(\\lambda_i) = \\beta_0 + \\beta_1 ~ price_i + \\beta_2 ~ room\\_type1_i + \\beta_3 ~ room\\_type2_i + \\log(days_i)$$ <br>\n\n**Note:** The response variable for the model is still $\\log(\\lambda_i)$, the log mean number of reviews\n\n## Detail on the offset {.midi}\n\nWe want to adjust for the number of days, so we are interested in $\\frac{reviews}{days}$.\n\n. . .\n\nGiven $\\lambda$ is the mean number of reviews\n\n$$\\log\\Big(\\frac{\\lambda_i}{days_i}\\Big) = \\beta_0 + \\beta_1 ~ price_i + \\beta_2 ~ room\\_type1_i + \\beta_3 ~ room\\_type2_i$$\n\n<br>\n\n. . .\n\n$$\\Rightarrow \\log({\\lambda_i}) - \\log(days_i) = \\beta_0 + \\beta_1 ~ price_i + \\beta_2 ~ room\\_type1_i + \\beta_3 ~ room\\_type2_i$$\n\n<br>\n\n. . .\n\n$$\\Rightarrow \\log({\\lambda_i}) = \\beta_0 + \\beta_1 ~ price_i + \\beta_2 ~ room\\_type1_i + \\beta_3 ~ room\\_type2_i + \\log(days_i)$$\n\n## Airbnb model in R {.midi}\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code  code-line-numbers=\"3\"}\nairbnb_model <- glm(number_of_reviews ~ price + room_type, \n                    data = airbnb, family = poisson, \n                    offset = log(days)) \n```\n:::\n\n::: {.cell layout-align=\"center\"}\n::: {.cell-output-display}\n\n\n|term                  | estimate| std.error| statistic| p.value|\n|:---------------------|--------:|---------:|---------:|-------:|\n|(Intercept)           |  -4.1351|    0.0170| -243.1397|       0|\n|price                 |  -0.0005|    0.0001|   -7.0952|       0|\n|room_typePrivate room |  -0.0994|    0.0174|   -5.6986|       0|\n|room_typeShared room  |   0.2436|    0.0452|    5.3841|       0|\n\n\n:::\n:::\n\n\n<br>\n\n. . .\n\nThe coefficient for $\\log(days)$ is fixed at 1, so it is not in the model output.\n\n## Interpretations {.midi}\n\n\n::: {.cell layout-align=\"center\"}\n::: {.cell-output-display}\n\n\n|term                  | estimate| std.error| statistic| p.value|\n|:---------------------|--------:|---------:|---------:|-------:|\n|(Intercept)           |  -4.1351|    0.0170| -243.1397|       0|\n|price                 |  -0.0005|    0.0001|   -7.0952|       0|\n|room_typePrivate room |  -0.0994|    0.0174|   -5.6986|       0|\n|room_typeShared room  |   0.2436|    0.0452|    5.3841|       0|\n\n\n:::\n:::\n\n\n<br>\n\n::: question\n-   Interpret the coefficient of `price`\n\n-   Interpret the coefficient of `room_typePrivate room`\n:::\n\n\n::: {.cell layout-align=\"center\"}\n::: {.cell-output-display}\n\n```{=html}\n<div class=\"countdown\" id=\"timer_d6ed51f9\" data-update-every=\"1\" tabindex=\"0\" style=\"right:0;bottom:0;margin:5%;\">\n<div class=\"countdown-controls\"><button class=\"countdown-bump-down\">&minus;</button><button class=\"countdown-bump-up\">&plus;</button></div>\n<code class=\"countdown-time\"><span class=\"countdown-digits minutes\">03</span><span class=\"countdown-digits colon\">:</span><span class=\"countdown-digits seconds\">00</span></code>\n</div>\n```\n\n:::\n:::\n\n\n## Quasi-Poisson model\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nairbnb_model_q <- glm(number_of_reviews ~ price + room_type, \n                    data = airbnb, family = quasipoisson, \n                    offset = log(days)) \n\nsummary(airbnb_model_q)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\nCall:\nglm(formula = number_of_reviews ~ price + room_type, family = quasipoisson, \n    data = airbnb, offset = log(days))\n\nCoefficients:\n                        Estimate Std. Error t value Pr(>|t|)    \n(Intercept)           -4.1350727  0.1159506 -35.662   <2e-16 ***\nprice                 -0.0004914  0.0004722  -1.041    0.298    \nroom_typePrivate room -0.0993582  0.1188728  -0.836    0.403    \nroom_typeShared room   0.2435939  0.3084581   0.790    0.430    \n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n\n(Dispersion parameter for quasipoisson family taken to be 46.48268)\n\n    Null deviance: 31550  on 999  degrees of freedom\nResidual deviance: 31379  on 996  degrees of freedom\nAIC: NA\n\nNumber of Fisher Scoring iterations: 6\n```\n\n\n:::\n:::\n\n\n## Quasi-Poisson model\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\ntidy(airbnb_model_q) |>\n  kable(digits = 4)\n```\n\n::: {.cell-output-display}\n\n\n|term                  | estimate| std.error| statistic| p.value|\n|:---------------------|--------:|---------:|---------:|-------:|\n|(Intercept)           |  -4.1351|    0.1160|  -35.6624|  0.0000|\n|price                 |  -0.0005|    0.0005|   -1.0407|  0.2983|\n|room_typePrivate room |  -0.0994|    0.1189|   -0.8358|  0.4034|\n|room_typeShared room  |   0.2436|    0.3085|    0.7897|  0.4299|\n\n\n:::\n:::\n\n\n# Zero-inflated Poisson model\n\n## Data: Weekend drinking {.midi}\n\nThe data [`weekend-drinks.csv`](data/weekend-drinks.csv) contains information from a survey of 77 students in a introductory statistics course on a dry campus.[^2]\n\n[^2]: Data from case study in [BMLR Section 4.10](https://bookdown.org/roback/bookdown-BeyondMLR/ch-poissonreg.html#cs:drinking).\n\n**Variables**\n\n-   `drinks`: Number of drinks they had in the past weekend\n-   `off_campus`: 1 - lives off campus, 0 otherwise\n-   `first_year`: 1 - student is a first-year, 0 otherwise\n-   `sex`: f - student identifies as female, m - student identifies as male\n\n**Goal**: The goal is explore factors related to drinking behavior on a dry campus.\n\n## EDA: Response variable\n\n\n::: {.cell layout-align=\"center\"}\n\n:::\n\n::: {.cell layout-align=\"center\"}\n::: {.cell-output-display}\n![](06-poisson-pt3_files/figure-revealjs/unnamed-chunk-15-1.png){fig-align='center' width=10%}\n:::\n:::\n\n::: {.cell layout-align=\"center\"}\n::: {.cell-output-display}\n\n\n|  mean|   var|\n|-----:|-----:|\n| 2.013| 10.75|\n\n\n:::\n:::\n\n\n## Observed vs. expected response\n\n\n::: {.cell layout-align=\"center\"}\n::: {.cell-output-display}\n![](06-poisson-pt3_files/figure-revealjs/unnamed-chunk-17-1.png){fig-align='center' width=10%}\n:::\n:::\n\n\n. . .\n\n<center><b>**What does it mean to be a \"zero\" in this data?**</b></center>\n\n## Two types of zeros {.midi}\n\nThere are two types of zeros\n\n-   Those who happen to have a zero in the data set (people who drink but happened to not drink last weekend)\n-   Those who will always report a value of zero (non-drinkers)\n    -   These are called **true zeros**\n\n. . .\n\nWe introduce a new parameter $\\alpha$ for the proportion of true zeros, then fit a model that has two components:\n\n. . .\n\n1Ô∏è‚É£ The association between mean number of drinks and various characteristics among those who drink\n\n2Ô∏è‚É£ The estimated proportion of non-drinkers\n\n## Zero-inflated Poisson model {.midi}\n\n**Zero-inflated Poisson (ZIP)** model has two parts\n\n1Ô∏è‚É£ Association, among those who drink, between the mean number of drinks and predictors sex and off campus residence\n\n$$\\log(\\lambda_i) = \\beta_0 + \\beta_1 ~ off\\_campus_i + \\beta_2 ~ sex_i$$ where $\\lambda$ is the mean number of drinks among those who drink\n\n. . .\n\n2Ô∏è‚É£ Probability that a student does not drink\n\n$$\\text{logit}(\\alpha_i) = \\log\\Big(\\frac{\\alpha_i}{1- \\alpha_i}\\Big) = \\beta_0 + \\beta_1 ~ first\\_year_i$$\n\nwhere $\\alpha$ is the proportion of non-drinkers\n\n. . .\n\n**Note:** The same variables can be used in each component\n\n## Details of the ZIP model\n\n-   The ZIP model is a special case of a **latent variable model**\n    -   A type of **mixture model** where observations for one or more groups occur together but the group membership unknown\n-   Zero-inflated models are a common type of mixture model; they apply beyond Poisson regression\n\n## ZIP model in R\n\nFit ZIP models using the `zeroinfl` function from the **pscl** R package.\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nlibrary(pscl)\n\ndrinks_zip <- zeroinfl(drinks ~ off_campus + sex | first_year,\n                data = drinks)\ndrinks_zip\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\nCall:\nzeroinfl(formula = drinks ~ off_campus + sex | first_year, data = drinks)\n\nCount model coefficients (poisson with log link):\n(Intercept)   off_campus         sexm  \n     0.7543       0.4159       1.0209  \n\nZero-inflation model coefficients (binomial with logit link):\n(Intercept)   first_year  \n    -0.6036       1.1364  \n```\n\n\n:::\n:::\n\n\n## Tidy output\n\nUse the `tidy` function from the **poissonreg** package for tidy model output.\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nlibrary(poissonreg)\n```\n:::\n\n\n<br>\n\n. . .\n\n**Mean number of drinks among those who drink**\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\ntidy(drinks_zip, type = \"count\") |> kable(digits = 3)\n```\n\n::: {.cell-output-display}\n\n\n|term        |type  | estimate| std.error| statistic| p.value|\n|:-----------|:-----|--------:|---------:|---------:|-------:|\n|(Intercept) |count |    0.754|     0.144|     5.238|   0.000|\n|off_campus  |count |    0.416|     0.206|     2.020|   0.043|\n|sexm        |count |    1.021|     0.175|     5.827|   0.000|\n\n\n:::\n:::\n\n\n## Tidy output\n\n**Proportion of non-drinkers**\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\ntidy(drinks_zip, type = \"zero\") |> kable(digits = 3)\n```\n\n::: {.cell-output-display}\n\n\n|term        |type | estimate| std.error| statistic| p.value|\n|:-----------|:----|--------:|---------:|---------:|-------:|\n|(Intercept) |zero |   -0.604|     0.311|    -1.938|   0.053|\n|first_year  |zero |    1.136|     0.610|     1.864|   0.062|\n\n\n:::\n:::\n\n\n## Interpreting the model coefficients\n\n\n::: {.cell layout-align=\"center\"}\n::: {.cell-output-display}\n\n\n|term        |type  | estimate| std.error| statistic| p.value|\n|:-----------|:-----|--------:|---------:|---------:|-------:|\n|(Intercept) |count |    0.754|     0.144|     5.238|   0.000|\n|off_campus  |count |    0.416|     0.206|     2.020|   0.043|\n|sexm        |count |    1.021|     0.175|     5.827|   0.000|\n\n\n:::\n:::\n\n\n<br>\n\n::: question\n-   Interpret the intercept.\n\n-   Interpret the coefficients `off_campus` and `sexm.`\n:::\n\n\n::: {.cell layout-align=\"center\"}\n::: {.cell-output-display}\n\n```{=html}\n<div class=\"countdown\" id=\"timer_8f82cf6d\" data-update-every=\"1\" tabindex=\"0\" style=\"right:0;bottom:0;margin:5%;\">\n<div class=\"countdown-controls\"><button class=\"countdown-bump-down\">&minus;</button><button class=\"countdown-bump-up\">&plus;</button></div>\n<code class=\"countdown-time\"><span class=\"countdown-digits minutes\">03</span><span class=\"countdown-digits colon\">:</span><span class=\"countdown-digits seconds\">00</span></code>\n</div>\n```\n\n:::\n:::\n\n\n## Estimated proportion zeros\n\n\n::: {.cell layout-align=\"center\"}\n::: {.cell-output-display}\n\n\n|term        |type | estimate| std.error| statistic| p.value|\n|:-----------|:----|--------:|---------:|---------:|-------:|\n|(Intercept) |zero |   -0.604|     0.311|    -1.938|   0.053|\n|first_year  |zero |    1.136|     0.610|     1.864|   0.062|\n\n\n:::\n:::\n\n\n::: question\nBased on the model...\n\n-   What is the probability a first-year student is a non-drinker?\n-   What is the probability a upperclass student (sophomore, junior, senior) is a non-drinker?\n:::\n\n\n::: {.cell layout-align=\"center\"}\n::: {.cell-output-display}\n\n```{=html}\n<div class=\"countdown\" id=\"timer_ce975e49\" data-update-every=\"1\" tabindex=\"0\" style=\"right:0;bottom:0;margin:5%;\">\n<div class=\"countdown-controls\"><button class=\"countdown-bump-down\">&minus;</button><button class=\"countdown-bump-up\">&plus;</button></div>\n<code class=\"countdown-time\"><span class=\"countdown-digits minutes\">02</span><span class=\"countdown-digits colon\">:</span><span class=\"countdown-digits seconds\">00</span></code>\n</div>\n```\n\n:::\n:::\n\n\n## Comparing Poisson and ZIP Models\n\n::: question\nSuppose we want to compare our ZIP model to a Poisson model $\\log(\\lambda_i) = \\beta_0 + \\beta_1 ~ off_campus_i + \\beta_2 ~ sex_i$\n\n<br>\n\nWhich of the following methods can we use to compare these models?\n\n-   AIC\n\n-   BIC\n\n-   Likelihood ratio test\n:::\n\n# Likelihoods for ZIP model\n\n## Probabilities under ZIP model\n\nThere are three different types of observations in the data:\n\n-   Observed 0 and will always be 0 (true zeros)\n-   Observed 0 but will not always be 0\n-   Observed non-zero count and will not always be 0\n\n## Probabilities under ZIP model\n\n**True zeros** $$P(0 | \\text{true zero})= \\alpha$$\n\n. . .\n\n**Observed 0 but will not always be 0**\n\n$$P(0 | \\text{not always zero}) = (1 - \\alpha)\\frac{e^{-\\lambda}\\lambda^0}{0!}$$\n\n. . .\n\n**Did not observe 0 and will not always be 0**\n\n$$P(z_i | \\text{not always zero}) = (1 - \\alpha)\\frac{e^{-\\lambda}\\lambda^{z_i}}{z_i!}$$\n\n## Probabilities under ZIP model {.midi}\n\nPutting this all together. Let $y_i$ be an observed response then\n\n$$P(Y_i = y_i) = \\begin{cases}\n\\alpha_i + (1 - \\alpha_i)e^{-\\lambda_i} && \\text{ if } y_i = 0 \\\\\n(1 - \\alpha_i)\\frac{e^{-\\lambda_i}\\lambda_i^{y_i}}{y_i!} && \\text{ if } y_i > 0\n\\end{cases}$$\n\n. . .\n\nRecall from our example,\n\n$$\\lambda_i = e^{\\beta_0 + \\beta_1~off\\_campus_i + \\beta_2 ~ sex_i}$$\n\n$$\\alpha_i = \\frac{e^{\\beta_{0\\alpha} + \\beta_{1\\alpha} ~ first\\_year_i}}{1 + e^{\\beta_{0\\alpha} + \\beta_{1\\alpha} ~ first\\_year_i}}$$\n\nPlug in $\\lambda_i$ and $\\alpha_i$ into the above equation obtain the likelihood function\n\n## References\n",
    "supporting": [
      "06-poisson-pt3_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {
      "include-in-header": [
        "<link href=\"../site_libs/countdown-0.4.0/countdown.css\" rel=\"stylesheet\" />\n<script src=\"../site_libs/countdown-0.4.0/countdown.js\"></script>\n"
      ],
      "include-after-body": [
        "\n<script>\n  // htmlwidgets need to know to resize themselves when slides are shown/hidden.\n  // Fire the \"slideenter\" event (handled by htmlwidgets.js) when the current\n  // slide changes (different for each slide format).\n  (function () {\n    // dispatch for htmlwidgets\n    function fireSlideEnter() {\n      const event = window.document.createEvent(\"Event\");\n      event.initEvent(\"slideenter\", true, true);\n      window.document.dispatchEvent(event);\n    }\n\n    function fireSlideChanged(previousSlide, currentSlide) {\n      fireSlideEnter();\n\n      // dispatch for shiny\n      if (window.jQuery) {\n        if (previousSlide) {\n          window.jQuery(previousSlide).trigger(\"hidden\");\n        }\n        if (currentSlide) {\n          window.jQuery(currentSlide).trigger(\"shown\");\n        }\n      }\n    }\n\n    // hookup for slidy\n    if (window.w3c_slidy) {\n      window.w3c_slidy.add_observer(function (slide_num) {\n        // slide_num starts at position 1\n        fireSlideChanged(null, w3c_slidy.slides[slide_num - 1]);\n      });\n    }\n\n  })();\n</script>\n\n"
      ]
    },
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}