{
  "hash": "f783cd1052a2ae87040676366dc46b2e",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"Modeling two-level longitudinal data\"\ndate: \"March 4, 2024\"\ndate-format: \"MMM DD, YYYY\"\nauthor: \"Prof. Maria Tackett\"\nfooter: \"[ðŸ”— STA 310 - Spring 2024](https://sta310-sp24.netlify.app)\"\nlogo: \"../images/logo.png\"\nformat: \n  revealjs:\n    theme: slides.scss\n    slide-number: true\n    multiplex: false\n    transition: fade\n    incremental: false \n    chalkboard: true\nhtml-math-method:\n  method: mathjax\n  url: \"https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js\"\nexecute:\n  freeze: auto\n  echo: true\n  warning: false\n  message: false\nknitr:\n  opts_chunk: \n    R.options:      \n    width: 200\nbibliography: references.bib\n---\n\n\n\n::: {.cell layout-align=\"center\"}\n\n:::\n\n\n## Announcements - UPDATE\n\n## Topics - UPDATE\n\n-   Fit and interpret multilevel models for longitudinal data\n\n::: aside\nNotes are based on Chapter 9 of @roback2021beyond, @boedeker2019hierarchical, @faraway2016extending, and @singer2003applied.\n:::\n\n# Modeling two-level longitudinal data\n\n## Data: Charter schools in MN {.midi}\n\nToday's data set contains standardized test scores and demographic information for schools in Minneapolis, MN from 2008 to 2010. The data were collected by the Minnesota Department of Education. Understanding the effectiveness of charter schools is of particular interest, since they often incorporate unique methods of instruction and learning that differ from public schools.\n\n-   **`MathAvgScore`**: Average MCA-II score for all 6th grade students in a school (response variable)\n-   **`urban`**: urban (1) or rural (0) location school location\n-   **`charter`**: charter school (1) or a non-charter public school (0)\n-   **`schPctfree`**: proportion of students who receive free or reduced lunches in a school (based on 2010 figures).\n-   **`year08`**: Years since 2008\n\n## Data {.midi}\n\n\n::: {.cell layout-align=\"center\"}\n\n:::\n\n::: {.cell layout-align=\"center\"}\n::: {.cell-output-display}\n`````{=html}\n<table>\n <thead>\n  <tr>\n   <th style=\"text-align:left;\"> schoolName </th>\n   <th style=\"text-align:right;\"> year08 </th>\n   <th style=\"text-align:right;\"> urban </th>\n   <th style=\"text-align:right;\"> charter </th>\n   <th style=\"text-align:right;\"> schPctfree </th>\n   <th style=\"text-align:right;\"> MathAvgScore </th>\n  </tr>\n </thead>\n<tbody>\n  <tr>\n   <td style=\"text-align:left;\"> RIPPLESIDE ELEMENTARY </td>\n   <td style=\"text-align:right;\"> 0 </td>\n   <td style=\"text-align:right;\"> 0 </td>\n   <td style=\"text-align:right;\"> 0 </td>\n   <td style=\"text-align:right;\"> 0.363 </td>\n   <td style=\"text-align:right;\"> 652.8 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> RIPPLESIDE ELEMENTARY </td>\n   <td style=\"text-align:right;\"> 1 </td>\n   <td style=\"text-align:right;\"> 0 </td>\n   <td style=\"text-align:right;\"> 0 </td>\n   <td style=\"text-align:right;\"> 0.363 </td>\n   <td style=\"text-align:right;\"> 656.6 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> RIPPLESIDE ELEMENTARY </td>\n   <td style=\"text-align:right;\"> 2 </td>\n   <td style=\"text-align:right;\"> 0 </td>\n   <td style=\"text-align:right;\"> 0 </td>\n   <td style=\"text-align:right;\"> 0.363 </td>\n   <td style=\"text-align:right;\"> 652.6 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> RICHARD ALLEN MATH&amp;SCIENCE ACADEMY </td>\n   <td style=\"text-align:right;\"> 0 </td>\n   <td style=\"text-align:right;\"> 1 </td>\n   <td style=\"text-align:right;\"> 1 </td>\n   <td style=\"text-align:right;\"> 0.545 </td>\n   <td style=\"text-align:right;\"> NA </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> RICHARD ALLEN MATH&amp;SCIENCE ACADEMY </td>\n   <td style=\"text-align:right;\"> 1 </td>\n   <td style=\"text-align:right;\"> 1 </td>\n   <td style=\"text-align:right;\"> 1 </td>\n   <td style=\"text-align:right;\"> 0.545 </td>\n   <td style=\"text-align:right;\"> NA </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> RICHARD ALLEN MATH&amp;SCIENCE ACADEMY </td>\n   <td style=\"text-align:right;\"> 2 </td>\n   <td style=\"text-align:right;\"> 1 </td>\n   <td style=\"text-align:right;\"> 1 </td>\n   <td style=\"text-align:right;\"> 0.545 </td>\n   <td style=\"text-align:right;\"> 631.2 </td>\n  </tr>\n</tbody>\n</table>\n\n`````\n:::\n:::\n\n\n## Assess missingness {.midi}\n\nMissing data is common in longitudinal data. Before starting the analysis, it is important to understand the missing data patterns. Use the `skim` function from the **skimr** R package to get a quick view of the missingness.\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nlibrary(skimr)\ncharter |> skim() |> select(skim_variable, n_missing, complete_rate)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 9 Ã— 3\n  skim_variable n_missing complete_rate\n  <chr>             <int>         <dbl>\n1 schoolid              0         1    \n2 schoolName            0         1    \n3 urban                 0         1    \n4 charter               0         1    \n5 schPctnonw            0         1    \n6 schPctsped            0         1    \n7 schPctfree            0         1    \n8 year08                0         1    \n9 MathAvgScore        121         0.935\n```\n\n\n:::\n:::\n\n\n## Closer look at missing data pattern\n\n\n::: {.cell layout-align=\"center\"}\n::: {.cell-output-display}\n`````{=html}\n<table>\n <thead>\n  <tr>\n   <th style=\"text-align:right;\"> MathAvgScore0_miss </th>\n   <th style=\"text-align:right;\"> MathAvgScore1_miss </th>\n   <th style=\"text-align:right;\"> MathAvgScore2_miss </th>\n   <th style=\"text-align:right;\"> n </th>\n  </tr>\n </thead>\n<tbody>\n  <tr>\n   <td style=\"text-align:right;\"> 0 </td>\n   <td style=\"text-align:right;\"> 0 </td>\n   <td style=\"text-align:right;\"> 0 </td>\n   <td style=\"text-align:right;\"> 540 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 0 </td>\n   <td style=\"text-align:right;\"> 0 </td>\n   <td style=\"text-align:right;\"> 1 </td>\n   <td style=\"text-align:right;\"> 6 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 0 </td>\n   <td style=\"text-align:right;\"> 1 </td>\n   <td style=\"text-align:right;\"> 0 </td>\n   <td style=\"text-align:right;\"> 4 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 0 </td>\n   <td style=\"text-align:right;\"> 1 </td>\n   <td style=\"text-align:right;\"> 1 </td>\n   <td style=\"text-align:right;\"> 7 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 1 </td>\n   <td style=\"text-align:right;\"> 0 </td>\n   <td style=\"text-align:right;\"> 0 </td>\n   <td style=\"text-align:right;\"> 25 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 1 </td>\n   <td style=\"text-align:right;\"> 0 </td>\n   <td style=\"text-align:right;\"> 1 </td>\n   <td style=\"text-align:right;\"> 1 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 1 </td>\n   <td style=\"text-align:right;\"> 1 </td>\n   <td style=\"text-align:right;\"> 0 </td>\n   <td style=\"text-align:right;\"> 35 </td>\n  </tr>\n</tbody>\n</table>\n\n`````\n:::\n:::\n\n\n## Code {.midi}\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\ncharter |>\n  select(schoolid, schoolName, year08, MathAvgScore) |>\n  pivot_wider(id_cols = c(schoolid, schoolName), names_from = year08,\n              names_prefix = \"MathAvgScore.\", values_from = MathAvgScore) |> \n  mutate(MathAvgScore0_miss = if_else(is.na(MathAvgScore.0), 1, 0),\n         MathAvgScore1_miss = if_else(is.na(MathAvgScore.1), 1, 0),\n         MathAvgScore2_miss = if_else(is.na(MathAvgScore.2), 1, 0)) |> \n  count(MathAvgScore0_miss, MathAvgScore1_miss, MathAvgScore2_miss) |> \n  kable()\n```\n:::\n\n\n## Dealing with missing data {.midi}\n\n::: incremental\n-   **Complete case analysis**: Only include schools with complete data for all three years.\n    -   Would remove 12.6% of observations in this data.\n-   **Last observation carried forward**: Keep the last observation from each group (school) and conduct analysis for independent observations.\n-   **Impute missing observations**: \"Fill in\" values of missing observations using the typical observed trends from groups with similar covariates.\n-   **Apply multilevel methods**: Estimate patterns using available data recognizing that trends for groups with complete data are more precise than for those with fewer measurements. This is under the condition that the probability of missingness does not depend on unobserved predictors or the response.\n:::\n\n------------------------------------------------------------------------\n\n.center\\[ .question\\[ What is an advantage of each method? What is a disadvantage?\\]\\]\n\n\n::: {.cell layout-align=\"center\"}\n::: {.cell-output-display}\n\n```{=html}\n<div class=\"countdown\" id=\"timer_4459514e\" data-update-every=\"1\" tabindex=\"0\" style=\"right:0;bottom:0;margin:1.25%;\">\n<div class=\"countdown-controls\"><button class=\"countdown-bump-down\">&minus;</button><button class=\"countdown-bump-up\">&plus;</button></div>\n<code class=\"countdown-time\"><span class=\"countdown-digits minutes\">03</span><span class=\"countdown-digits colon\">:</span><span class=\"countdown-digits seconds\">00</span></code>\n</div>\n```\n\n:::\n:::\n\n\n## Strategy for building multilevel models\n\n-   Conduct exploratory data analysis for Level One and Level Two variables.\n\n-   Fit model with no covariates to assess variability at each level.\n\n-   Create Level One models. Start with a single term, then add terms as needed.\n\n-   Create Level Two models. Start with a single term, then add terms as needed. Start with equation for intercept term.\n\n-   Begin with the full set of variance components, then remove variance terms as needed.\n\n*Alternate model building strategies in BMLR Section 8.6*\n\n## Exploratory data analysis\n\nGiven the longitudinal structure of the data, we are able to answer questions at two levels\n\n-   **Level One (within school)**: How did average math scores for a given school change over time?\n\n-   **Level Two (between schools)**: What is the effect of school-specific covariates on the average math scores in 2008 and the rate of change from 2008 to 2010?\n\nWe can conduct exploratory data analysis at both levels, e.g.,\n\n-   Univariate and bivariate EDA\n-   Lattice plots\n-   Spaghetti plots\n\n# Application exercise\n\n.question\\[ Conduct exploratory data analysis in `lecture-18.Rmd`.\\]\n\nSee BMLR Section 9.3 for full exploratory data analysis.\n\n## Unconditional means model\n\nStart with the **unconditional means model**, a model with no covariates at any level. This is also called the random intercepts model.\n\n**Level One** : $Y_{ij} = a_{i} + \\epsilon_{ij}, \\hspace{5mm} \\epsilon_{ij} \\sim N(0, \\sigma^2)$\n\n**Level Two**: $a_i = \\alpha_0 + u_i, \\hspace{5mm} u_{i} \\sim N(0, \\sigma^2_u)$\n\n::: question\nWrite the composite model.\n:::\n\n## Intraclass correlation\n\nThe **intraclass correlation** is the relative variability between groups\n\n$$\\hat{\\rho} = \\frac{\\text{Between variability}}{\\text{Total variability}} = \\frac{\\hat{\\sigma}_u^2}{\\hat{\\sigma}^2_u + \\hat{\\sigma}^2}$$\n\n::: question\n-   Fit the unconditional means model and calculate the intraclass correlation.\n\n-   What does this mean?\n:::\n\n## Unconditional growth model\n\nA next step in the model building is the **unconditional growth model**, a model with Level One predictors but no Level Two predictors.\n\n**Level One**: $Y_{ij} = a_i + b_iYear08_{ij} + \\epsilon_{ij}$\n\n**Level Two**:\n\n-   $a_i = \\alpha_0 + u_i$\n-   $b_i = \\beta_0 + v_i$\n\n::: question\n-   Write the composite model.\n-   Fit the unconditional growth model.\n-   What can we learn from this model?\n:::\n\n## Pseudo $R^2$\n\nWe can use **Pseudo R**<sup>2</sup> to explain changes in variance components between two models\n\n-   **Note**: This should only be used when the definition of the variance component is the same between the two models\n\n$$\\text{Pseudo }R^2 = \\frac{\\hat{\\sigma}^2(\\text{Model 1})  -  \\hat{\\sigma}^2(\\text{Model 2})}{\\hat{\\sigma}^2(\\text{Model 1})}$$\n\n::: question\nCalculate the $\\text{Pseudo }R^2$ to estimate the change of within school variance between the unconditional means and unconditional growth models.\n:::\n\n## Model with school-level covariates {.midi}\n\nFit a model with school-level covariates that takes the following form:\n\n**Level One**\n\n\n```{=tex}\n\\begin{equation*}\nY_{ij}= a_{i} + b_{i}Year08_{ij} + \\epsilon_{ij}\n\\end{equation*}\n```\n\n**Level Two**\n\n\n```{=tex}\n\\begin{align*}\na_{i} & = \\alpha_{0} + \\alpha_{1}Charter_i + \\alpha_{2}urban_i + \\alpha_{3}schpctfree_i + u_{i} \\\\\nb_{i} & = \\beta_{0} + \\beta_{1}Charter_i + \\beta_{2}urban_i + v_{i}\n\\end{align*}\n```\n\n::: question\n-   Write out the composite model.\n-   Fit the model in R.\n-   Use the model to describe how the average math scores differed between charter and non-charter schools.\n:::\n\n## Consider a simpler model\n\n<center>Would a model without the effects $v_i$ and $\\rho_{uv}$ be preferable?</center>\n\n. . .\n\n**Level One**\n\n\n```{=tex}\n\\begin{equation*}\nY_{ij}= a_{i} + b_{i}Year08_{ij} + \\epsilon_{ij}\n\\end{equation*}\n```\n\n**Level Two**\n\n\n```{=tex}\n\\begin{align*}\na_{i} & = \\alpha_{0} + \\alpha_{1}Charter_i + \\alpha_{2}urban_i + \\alpha_{3}schpctfree_i + u_{i} \\\\\nb_{i} & = \\beta_{0} + \\beta_{1}Charter_i + \\beta_{2}urban_i \n\\end{align*}\n```\n\n<br>\n\n. . .\n\nIn this model, the effect of year is the same for all schools with a given combination of `Charter` and `urban`\n\n## Full and reduced models\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code  code-line-numbers=\"3\"}\nfull_model <- lmer(MathAvgScore ~ charter + urban + schPctfree + \n                     charter:year08  + urban:year08 + year08 + \n                     (year08|schoolid), REML = F, data = charter) \n```\n:::\n\n\n<br>\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code  code-line-numbers=\"3\"}\nreduced_model <-  lmer(MathAvgScore ~ charter + urban + schPctfree + \n                     charter:year08  + urban:year08 + year08 +\n                       (1 | schoolid), REML = F, data = charter) \n```\n:::\n\n\n## Notes on drop-in-deviance test\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nanova(full_model, reduced_model, test = \"LRT\") |>\n  kable(digits = 3)\n```\n\n::: {.cell-output-display}\n`````{=html}\n<table>\n <thead>\n  <tr>\n   <th style=\"text-align:left;\">   </th>\n   <th style=\"text-align:right;\"> npar </th>\n   <th style=\"text-align:right;\"> AIC </th>\n   <th style=\"text-align:right;\"> BIC </th>\n   <th style=\"text-align:right;\"> logLik </th>\n   <th style=\"text-align:right;\"> deviance </th>\n   <th style=\"text-align:right;\"> Chisq </th>\n   <th style=\"text-align:right;\"> Df </th>\n   <th style=\"text-align:right;\"> Pr(&gt;Chisq) </th>\n  </tr>\n </thead>\n<tbody>\n  <tr>\n   <td style=\"text-align:left;\"> reduced_model </td>\n   <td style=\"text-align:right;\"> 9 </td>\n   <td style=\"text-align:right;\"> 9952.992 </td>\n   <td style=\"text-align:right;\"> 10002.11 </td>\n   <td style=\"text-align:right;\"> -4967.496 </td>\n   <td style=\"text-align:right;\"> 9934.992 </td>\n   <td style=\"text-align:right;\"> NA </td>\n   <td style=\"text-align:right;\"> NA </td>\n   <td style=\"text-align:right;\"> NA </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> full_model </td>\n   <td style=\"text-align:right;\"> 11 </td>\n   <td style=\"text-align:right;\"> 9953.793 </td>\n   <td style=\"text-align:right;\"> 10013.83 </td>\n   <td style=\"text-align:right;\"> -4965.897 </td>\n   <td style=\"text-align:right;\"> 9931.793 </td>\n   <td style=\"text-align:right;\"> 3.199 </td>\n   <td style=\"text-align:right;\"> 2 </td>\n   <td style=\"text-align:right;\"> 0.202 </td>\n  </tr>\n</tbody>\n</table>\n\n`````\n:::\n:::\n\n\n. . .\n\n-   $\\chi^2$ test is conservative, i.e., the p-values are larger than they should be, when testing random effects at the boundary ( e.g., $\\sigma_v^2 = 0$) or those with bounded ranges (e.g., $\\rho_{uv}$ )\n\n-   If you observe small p-values, you can feel relatively certain the tested effects are statistically significant\n\n-   Use bootstrap methods to obtain more accurate p-values\n\n## References\n",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {
      "include-in-header": [
        "<link href=\"../site_libs/countdown-0.4.0/countdown.css\" rel=\"stylesheet\" />\n<script src=\"../site_libs/countdown-0.4.0/countdown.js\"></script>\n"
      ],
      "include-after-body": [
        "\n<script>\n  // htmlwidgets need to know to resize themselves when slides are shown/hidden.\n  // Fire the \"slideenter\" event (handled by htmlwidgets.js) when the current\n  // slide changes (different for each slide format).\n  (function () {\n    // dispatch for htmlwidgets\n    function fireSlideEnter() {\n      const event = window.document.createEvent(\"Event\");\n      event.initEvent(\"slideenter\", true, true);\n      window.document.dispatchEvent(event);\n    }\n\n    function fireSlideChanged(previousSlide, currentSlide) {\n      fireSlideEnter();\n\n      // dispatch for shiny\n      if (window.jQuery) {\n        if (previousSlide) {\n          window.jQuery(previousSlide).trigger(\"hidden\");\n        }\n        if (currentSlide) {\n          window.jQuery(currentSlide).trigger(\"shown\");\n        }\n      }\n    }\n\n    // hookup for slidy\n    if (window.w3c_slidy) {\n      window.w3c_slidy.add_observer(function (slide_num) {\n        // slide_num starts at position 1\n        fireSlideChanged(null, w3c_slidy.slides[slide_num - 1]);\n      });\n    }\n\n  })();\n</script>\n\n"
      ]
    },
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}