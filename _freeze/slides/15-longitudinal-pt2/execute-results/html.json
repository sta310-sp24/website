{
  "hash": "fbb4d5a62995764069c3b5889d86e226",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"Modeling two-level longitudinal data\"\nsubtitle: \"Inference for fixed and random effects\"\ndate: \"March 6, 2024\"\ndate-format: \"MMM DD, YYYY\"\nauthor: \"Prof. Maria Tackett\"\nfooter: \"[üîó STA 310 - Spring 2024](https://sta310-sp24.netlify.app)\"\nlogo: \"../images/logo.png\"\nformat: \n  revealjs:\n    theme: slides.scss\n    slide-number: true\n    multiplex: false\n    transition: fade\n    incremental: false \n    chalkboard: true\nhtml-math-method:\n  method: mathjax\n  url: \"https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js\"\nexecute:\n  freeze: auto\n  echo: true\n  warning: false\n  message: false\nknitr:\n  opts_chunk: \n    R.options:      \n    width: 200\nbibliography: references.bib\n---\n\n\n\n::: {.cell layout-align=\"center\"}\n\n:::\n\n\n## Announcements\n\n-   Quiz 03 - due Thu, Mar 06 at noon\n\n    -   Covers readings and lectures in Feb 19 - 28 lectures\n\n    -   Correlated data, multilevel models\n\n-   HW 04 - due Wed, Mar 20\n\n    -   Released Thu, Mar 06 \\~ 9am\n\n## Topics\n\n-   Inference for fixed and random effects\n\n::: aside\nNotes are based on Chapter 9 of @roback2021beyond, @boedeker2019hierarchical, @faraway2016extending, and @singer2003applied.\n:::\n\n# Modeling two-level longitudinal data\n\n## Data: Charter schools in MN {.midi}\n\nToday's data set contains standardized test scores and demographic information for schools in Minneapolis, MN from 2008 to 2010. The data were collected by the Minnesota Department of Education. Understanding the effectiveness of charter schools is of particular interest, since they often incorporate unique methods of instruction and learning that differ from public schools.\n\n-   **`MathAvgScore`**: Average MCA-II score for all 6th grade students in a school (response variable)\n-   **`urban`**: urban (1) or rural (0) location school location\n-   **`charter`**: charter school (1) or a non-charter public school (0)\n-   **`schPctfree`**: proportion of students who receive free or reduced lunches in a school (based on 2010 figures).\n-   **`year08`**: Years since 2008\n\n## Data {.small}\n\n\n::: {.cell layout-align=\"center\"}\n\n:::\n\n::: {.cell layout-align=\"center\"}\n::: {.cell-output-display}\n\n\n|schoolName                         | year08| urban| charter| schPctfree| MathAvgScore|\n|:----------------------------------|------:|-----:|-------:|----------:|------------:|\n|RIPPLESIDE ELEMENTARY              |      0|     0|       0|      0.363|        652.8|\n|RIPPLESIDE ELEMENTARY              |      1|     0|       0|      0.363|        656.6|\n|RIPPLESIDE ELEMENTARY              |      2|     0|       0|      0.363|        652.6|\n|RICHARD ALLEN MATH&SCIENCE ACADEMY |      0|     1|       1|      0.545|           NA|\n|RICHARD ALLEN MATH&SCIENCE ACADEMY |      1|     1|       1|      0.545|           NA|\n|RICHARD ALLEN MATH&SCIENCE ACADEMY |      2|     1|       1|      0.545|        631.2|\n\n\n:::\n:::\n\n\n## Closer look at missing data pattern\n\n\n::: {.cell layout-align=\"center\"}\n::: {.cell-output-display}\n\n\n| MathAvgScore0_miss| MathAvgScore1_miss| MathAvgScore2_miss|   n|\n|------------------:|------------------:|------------------:|---:|\n|                  0|                  0|                  0| 540|\n|                  0|                  0|                  1|   6|\n|                  0|                  1|                  0|   4|\n|                  0|                  1|                  1|   7|\n|                  1|                  0|                  0|  25|\n|                  1|                  0|                  1|   1|\n|                  1|                  1|                  0|  35|\n\n\n:::\n:::\n\n\n```         \n```\n\n## Exploratory data analysis {.midi}\n\n## Unconditional means model\n\nStart with the **unconditional means model**, a model with no covariates at any level. This is also called the random intercepts model.\n\n**Level One** : $Y_{ij} = a_{i} + \\epsilon_{ij}, \\hspace{5mm} \\epsilon_{ij} \\sim N(0, \\sigma^2)$\n\n**Level Two**: $a_i = \\alpha_0 + u_i, \\hspace{5mm} u_{i} \\sim N(0, \\sigma^2_u)$<br>\n\n## Unconditional growth model\n\nA next step in the model building is the **unconditional growth model**, a model with Level One predictors but no Level Two predictors.\n\n**Level One**\n\n$$\nY_{ij} = a_i + b_iYear08_{ij} + \\epsilon_{ij}, \\hspace{8mm} \\epsilon_{ij} \\sim N(0, \\sigma^2)\n$$\n\n**Level Two**:\n\n$$\n\\begin{aligned}\n&a_i = \\alpha_0 + u_i \\hspace{20mm} b_i = \\beta_0 + v_i \\\\\n&\\left[ \\begin{array}{c}\n            u_{i} \\\\ v_{i}\n          \\end{array}  \\right] \\sim N \\left( \\left[\n          \\begin{array}{c}\n            0 \\\\ 0\n          \\end{array} \\right], \\left[\n          \\begin{array}{cc}\n            \\sigma_{u}^{2} & \\sigma_{uv} \\\\\n            \\sigma_{uv} & \\sigma_{v}^{2}\n          \\end{array} \\right] \\right)\n\\end{aligned}\n$$\n\n## Model with school-level covariates {.midi}\n\nFit a model with school-level covariates that takes the following form:\n\n**Level One**\n\n\n```{=tex}\n\\begin{equation*}\nY_{ij}= a_{i} + b_{i}Year08_{ij} + \\epsilon_{ij} \\hspace{10mm} \\epsilon_{ij} \\sim N(0, \\sigma^2)\n\\end{equation*}\n```\n\n**Level Two**\n\n\n```{=tex}\n\\begin{align*}\na_{i} & = \\alpha_{0} + \\alpha_{1}charter_i + \\alpha_{2}urban_i + \\alpha_{3}schpctfree_i + u_{i} \\\\\nb_{i} & = \\beta_{0} + \\beta_{1}charter_i + \\beta_{2}urban_i + v_{i} \\\\[10pt]\n&\\left[ \\begin{array}{c}\n            u_{i} \\\\ v_{i}\n          \\end{array}  \\right] \\sim N \\left( \\left[\n          \\begin{array}{c}\n            0 \\\\ 0\n          \\end{array} \\right], \\left[\n          \\begin{array}{cc}\n            \\sigma_{u}^{2} & \\sigma_{uv} \\\\\n            \\sigma_{uv} & \\sigma_{v}^{2}\n          \\end{array} \\right] \\right)\n\\end{align*}\n```\n\n## Model with school-level covariates\n\n::: question\n-   Fit the model in R.\n-   Use the model to describe how the average math scores differed between charter and non-charter schools.\n:::\n\n## Consider a simpler model {.midi}\n\n<center>Would a model without the effects $v_i$ and $\\rho_{uv}$ be preferable?</center>\n\n. . .\n\n**Level One**\n\n\n```{=tex}\n\\begin{equation*}\nY_{ij}= a_{i} + b_{i}Year08_{ij} + \\epsilon_{ij} \\hspace{10mm} \\epsilon_{ij} \\sim N(0, \\sigma^2)\n\\end{equation*}\n```\n\n**Level Two**\n\n\n```{=tex}\n\\begin{align*}\na_{i} & = \\alpha_{0} + \\alpha_{1}charter_i + \\alpha_{2}urban_i + \\alpha_{3}schpctfree_i + u_{i} \\\\\n& u_i \\sim N(0, \\sigma_u^2) \\\\[5pt]\nb_{i} & = \\beta_{0} + \\beta_{1}charter_i + \\beta_{2}urban_i  \n\\end{align*}\n```\n\n. . .\n\nIn this model, the effect of year is the same for all schools with a given combination of `charter` and `urban`\n\n## Full and reduced models\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code  code-line-numbers=\"3\"}\nfull_model <- lmer(MathAvgScore ~ charter + urban + schPctfree + \n                     charter:year08  + urban:year08 + year08 + \n                     (year08|schoolid), REML = F, data = charter) \n```\n:::\n\n\n<br>\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code  code-line-numbers=\"3\"}\nreduced_model <-  lmer(MathAvgScore ~ charter + urban + schPctfree + \n                     charter:year08  + urban:year08 + year08 +\n                       (1 | schoolid), REML = F, data = charter) \n```\n:::\n\n\n## Likelihood ratio test {.midi}\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nanova(full_model, reduced_model, test = \"LRT\") |>\n  kable(digits = 3)\n```\n\n::: {.cell-output-display}\n\n\n|              | npar|      AIC|      BIC|    logLik| deviance| Chisq| Df| Pr(>Chisq)|\n|:-------------|----:|--------:|--------:|---------:|--------:|-----:|--:|----------:|\n|reduced_model |    9| 9952.992| 10002.11| -4967.496| 9934.992|    NA| NA|         NA|\n|full_model    |   11| 9953.793| 10013.83| -4965.897| 9931.793| 3.199|  2|      0.202|\n\n\n:::\n:::\n\n\n. . .\n\n::: incremental\n-   $\\chi^2$ test is conservative, i.e., the p-values are larger than they should be, when testing random effects at the boundary ( e.g., $\\sigma_v^2 = 0$) or those with bounded ranges (e.g., $\\rho_{uv}$ )\n\n-   If you observe small p-values, you can feel relatively certain the tested effects are statistically significant\n\n-   Use bootstrap methods to calculate confidence intervals or obtain more accurate p-values (see [Section 9.6.4](https://bookdown.org/roback/bookdown-BeyondMLR/ch-lon.html#longitudinal-paraboot) for more detail on bootstrapping for LRT)\n:::\n\n## Bootstrapping\n\n-   **Bootstrapping** is from the phrase \"pulling oneself up by one‚Äôs bootstraps\"\n\n-   Accomplishing a difficult task without any outside help\n\n-   **Task**: conduct inference for model parameters (fixed and random effects) using only the sample data\n\n## Nonparametric bootstrapping {.small}\n\n1Ô∏è‚É£ ¬† Take a sample, with replacement, of size $n$ (the size of the original data) (called *case resampling*).\n\n<br>\n\n2Ô∏è‚É£ ¬† Fit the model to obtain estimates of the coefficients.\n\n<br>\n\n3Ô∏è‚É£ ¬† Repeat steps 1 - 2 many times (\\~ 1000) to obtain the bootstrap distribution.\n\n<br>\n\n4Ô∏è‚É£ ¬† Get the coefficients for the 95% confidence interval by taking the middle 95% of the bootstrap distribution.\n\n## Bootstrap CI {.small}\n\nUse the `confint` function to calculate bootstrapped confidence intervals to conduct inference on the fixed and random effects\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nconfint(full_model, method = \"boot\", oldNames = FALSE) |>\n  kable(digits = 4)\n```\n\n::: {.cell-output-display}\n\n\n|                                     |    2.5 %|   97.5 %|\n|:------------------------------------|--------:|--------:|\n|sd_(Intercept)&#124;schoolid         |   3.9607|   4.6798|\n|cor_year08.(Intercept)&#124;schoolid |  -0.2763|   1.0000|\n|sd_year08&#124;schoolid              |   0.0417|   0.8715|\n|sigma                                |   2.7978|   3.0869|\n|(Intercept)                          | 659.3807| 661.3582|\n|charter                              |  -4.2621|  -1.5047|\n|urban                                |  -2.0537|  -0.2665|\n|schPctfree                           | -19.1619| -15.8609|\n|year08                               |   1.2270|   1.7998|\n|charter:year08                       |   0.3660|   1.6615|\n|urban:year08                         |  -0.9074|  -0.1207|\n\n\n:::\n:::\n\n\n## Bootstrap CI {.midi}\n\n::: columns\n::: {.column width=\"70%\"}\n\n::: {.cell layout-align=\"center\"}\n::: {.cell-output-display}\n\n\n|                                     |    2.5 %|   97.5 %|\n|:------------------------------------|--------:|--------:|\n|sd_(Intercept)&#124;schoolid         |   3.9840|   4.6955|\n|cor_year08.(Intercept)&#124;schoolid |  -0.1178|   1.0000|\n|sd_year08&#124;schoolid              |   0.0388|   0.9196|\n|sigma                                |   2.7797|   3.0704|\n|(Intercept)                          | 659.4439| 661.2883|\n|charter                              |  -4.3766|  -1.5730|\n|urban                                |  -1.9167|  -0.2616|\n|schPctfree                           | -19.3234| -16.0920|\n|year08                               |   1.2226|   1.8152|\n|charter:year08                       |   0.3518|   1.6764|\n|urban:year08                         |  -0.9522|  -0.1943|\n\n\n:::\n:::\n\n:::\n\n::: {.column width=\"30%\"}\n::: question\nWould you keep $\\sigma_{v}$ and/or $\\rho_{uv}$ in the model?\n:::\n:::\n:::\n\n## Inference for fixed effects {.midi}\n\n-   The output for multilevel models do not contain p-values for the coefficients of fixed effects\n\n-   The exact distribution of the test statistic under the null hypothesis (no fixed effect) is unknown, because the exact degrees of freedom are unknown\n\n    -   Finding suitable approximations is an area of ongoing research\n\n-   We can use likelihood ratio test with an approximate $\\chi^2$ distribution to test these effects, since we're not testing on the boundary and fixed effects do not have limited ranges\n\n    -   Some research suggests the p-values are too low but approximations are generally pretty good\n    -   Can also calculate the p-values using parametric bootstrap approach\n\n## Methods to conduct inference for individual coefficients {.midi}\n\n-   Use the t-value $\\big(\\frac{estimate}{std.error}\\big)$ in the model output\n    -   General rule: Coefficients with \\|t-value\\| \\> 2 considered to be statistically significant, i.e., different from 0\n-   Calculate confidence intervals using **nonparametric bootstrapping**\n\n## Summary: Model comparisons {.midi}\n\n**Methods to compare models with different fixed effects**\n\n-   AIC or BIC\n-   Nonparametric bootstrap confidence intervals\n-   Likelihood ratio tests based on $\\chi^2$ distribution\n-   Likelihood ratio test based on parametric bootstrapped p-values (see [Section 9.6.4](https://bookdown.org/roback/bookdown-BeyondMLR/ch-lon.html#longitudinal-paraboot) for more detail)\n\n**Methods to compare models with different variance components**\n\n-   AIC or BIC\n-   Nonparametric bootstrap confidence intervals\n-   Likelihood ratio test based on parametric bootstrapped p-values (see [Section 9.6.4](https://bookdown.org/roback/bookdown-BeyondMLR/ch-lon.html#longitudinal-paraboot) for more detail)\n\n## Summary: Understanding the model\n\n**Methods to understand individual coefficients**\n\n-   Likelihood ratio tests\n-   Bootstrap confidence intervals\n-   Pseudo $R^2$ for variance components (if meaning is unchanged between models)\n\n**Methods to understand data structure**\n\n-   Calculate intraclass correlation coefficient using unconditional means model\n\n## References\n",
    "supporting": [
      "15-longitudinal-pt2_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {
      "include-after-body": [
        "\n<script>\n  // htmlwidgets need to know to resize themselves when slides are shown/hidden.\n  // Fire the \"slideenter\" event (handled by htmlwidgets.js) when the current\n  // slide changes (different for each slide format).\n  (function () {\n    // dispatch for htmlwidgets\n    function fireSlideEnter() {\n      const event = window.document.createEvent(\"Event\");\n      event.initEvent(\"slideenter\", true, true);\n      window.document.dispatchEvent(event);\n    }\n\n    function fireSlideChanged(previousSlide, currentSlide) {\n      fireSlideEnter();\n\n      // dispatch for shiny\n      if (window.jQuery) {\n        if (previousSlide) {\n          window.jQuery(previousSlide).trigger(\"hidden\");\n        }\n        if (currentSlide) {\n          window.jQuery(currentSlide).trigger(\"shown\");\n        }\n      }\n    }\n\n    // hookup for slidy\n    if (window.w3c_slidy) {\n      window.w3c_slidy.add_observer(function (slide_num) {\n        // slide_num starts at position 1\n        fireSlideChanged(null, w3c_slidy.slides[slide_num - 1]);\n      });\n    }\n\n  })();\n</script>\n\n"
      ]
    },
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}