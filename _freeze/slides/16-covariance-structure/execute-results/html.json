{
  "hash": "446bbf87f861e86bae9a5c5fba6f0020",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"Covariance structure of observations\"\ndate: \"March 18, 2024\"\ndate-format: \"MMM DD, YYYY\"\nauthor: \"Prof. Maria Tackett\"\nfooter: \"[ðŸ”— STA 310 - Spring 2024](https://sta310-sp24.netlify.app)\"\nlogo: \"../images/logo.png\"\nformat: \n  revealjs:\n    theme: slides.scss\n    slide-number: true\n    multiplex: false\n    transition: fade\n    incremental: false \n    chalkboard: true\nhtml-math-method:\n  method: mathjax\n  url: \"https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js\"\nexecute:\n  freeze: auto\n  echo: true\n  warning: false\n  message: false\nknitr:\n  opts_chunk: \n    R.options:      \n    width: 200\nbibliography: references.bib\n---\n\n\n\n::: {.cell layout-align=\"center\"}\n\n:::\n\n\n## Announcements\n\n-   HW 04 due TODAY\n\n-   Project 02\n\n## Topics\n\n-   Define the covariance structure of observations for a given model\n-   Understand how the covariance structure of observations differs from the covariance structure of error terms\n-   Calculate variance and covariance from model estimates\n\n::: aside\nNotes are based on Section 9.7 of @roback2021beyond.\n:::\n\n## Data: Charter schools in MN {.midi}\n\nToday's data set contains standardized test scores and demographic information for schools in Minneapolis, MN from 2008 to 2010. The data were collected by the Minnesota Department of Education. Understanding the effectiveness of charter schools is of particular interest, since they often incorporate unique methods of instruction and learning that differ from public schools.\n\n-   **`MathAvgScore`**: Average MCA-II score for all 6th grade students in a school (response variable)\n-   **`urban`**: urban (1) or rural (0) location school location\n-   **`charter`**: charter school (1) or a non-charter public school (0)\n-   **`schPctfree`**: proportion of students who receive free or reduced lunches in a school (based on 2010 figures).\n-   **`year08`**: Years since 2008\n\n## Data {.small}\n\n\n::: {.cell layout-align=\"center\"}\n\n:::\n\n::: {.cell layout-align=\"center\"}\n::: {.cell-output-display}\n\n\n|schoolName                         | year08|urban |charter | schPctfree| MathAvgScore|\n|:----------------------------------|------:|:-----|:-------|----------:|------------:|\n|RIPPLESIDE ELEMENTARY              |      0|0     |0       |      0.363|        652.8|\n|RIPPLESIDE ELEMENTARY              |      1|0     |0       |      0.363|        656.6|\n|RIPPLESIDE ELEMENTARY              |      2|0     |0       |      0.363|        652.6|\n|RICHARD ALLEN MATH&SCIENCE ACADEMY |      0|1     |1       |      0.545|           NA|\n|RICHARD ALLEN MATH&SCIENCE ACADEMY |      1|1     |1       |      0.545|           NA|\n|RICHARD ALLEN MATH&SCIENCE ACADEMY |      2|1     |1       |      0.545|        631.2|\n\n\n:::\n:::\n\n\n## Exploratory data analysis {.midi}\n\n\n::: {.cell layout-align=\"center\"}\n::: {.cell-output-display}\n![](16-covariance-structure_files/figure-revealjs/unnamed-chunk-4-1.png){fig-align='center' width=70%}\n:::\n:::\n\n\n## Exploratory data analysis {.midi}\n\n\n::: {.cell layout-align=\"center\"}\n::: {.cell-output-display}\n![](16-covariance-structure_files/figure-revealjs/unnamed-chunk-5-1.png){fig-align='center' width=70%}\n:::\n:::\n\n\n## Model\n\nWe will use Model C[^1]: Uncontrolled effects for school type.\n\n[^1]: From [Section 9.6.1](https://bookdown.org/roback/bookdown-BeyondMLR/ch-lon.html#sec:modelc9)\n\n$$\n\\begin{aligned}\nY_{ij} &= \\alpha_0 + \\alpha_1Charter_i + \\beta_0Year08_{ij} + \\beta_1Charter_iYear08_{ij}\\\\&+ u_i + v_iYear08_{ij} + \\epsilon_{ij} \\\\[8pt]\n&\\epsilon_{ij} \\sim N(0, \\sigma^2) \\hspace{15mm}  \\left[ \\begin{array}{c}\n            u_{i} \\\\ v_{i}\n          \\end{array}  \\right] \\sim N \\left( \\left[\n          \\begin{array}{c}\n            0 \\\\ 0\n          \\end{array} \\right], \\left[\n          \\begin{array}{cc}\n            \\sigma_{u}^{2} & \\sigma_{uv} \\\\\n            \\sigma_{uv} & \\sigma_{v}^{2}\n          \\end{array} \\right] \\right)\n\\end{aligned}\n$$\n\n## What we've done\n\nSo far we have discussed...\n\n-   the covariance structure between error terms at a given level, e.g. the distribution of between $u_i$ and $v_i$ from a Level Two model:\n\n$$\\left[ \\begin{array}{c}\n            u_{i} \\\\ v_{i}\n          \\end{array}  \\right] \\sim N \\left( \\left[\n          \\begin{array}{c}\n            0 \\\\ 0\n          \\end{array} \\right], \\left[\n          \\begin{array}{cc}\n            \\sigma_{u}^{2} & \\sigma_{uv} \\\\\n            \\sigma_{uv} & \\sigma_{v}^{2}\n          \\end{array} \\right] \\right)$$\n\n. . .\n\n-   how to use the intraclass correlation coefficient to get an idea of the average correlation between observations nested in the same Level Two group\n\n## Questions we want to answer\n\nNow we want to be able to answer more specific questions about the covariance (and correlation) structure of *observations* at different levels.\n\n-   What is the relative variability of 2008 and 2010 scores from the same school?\n\n-   What is the correlation between 2008 and 2009 scores from the same school? What is the correlation between 2009 and 2010 scores? 2008 and 2010?\n\n## Covariance structure \n\nThe covariance structure of the three time points (2008, 2009, 2010) for School $i$ is\n\n$$\\small{Cov(\\textbf{Y}_{i}) = \\left[\n          \\begin{array}{ccc}\n            Var(Y_{i1}) & Cov(Y_{i1}, Y_{i2}) & Cov(Y_{i1}, Y_{i3})\\\\\n           Cov(Y_{i1}, Y_{i2}) & Var(Y_{i2})& Cov(Y_{i2}, Y_{i3}) \\\\\n           Cov(Y_{i1}, Y_{i3}) &Cov(Y_{i2}, Y_{i3}) &  Var(Y_{i3})\\\\\n          \\end{array} \\right]}$$\n\n. . .\n\n::: question\nDo you expect the covariances to be positive or negative? Why?\n:::\n\n## Covariance structure and error terms\n\nNote that covariance structure of observations is <u>not</u> the same as the error structure at Level Two.\n\n$$\nCov(\\mathbf{Y}_i) \\neq \\left[ \\begin{array}{c}\n            u_{i} \\\\ v_{i}\n          \\end{array}  \\right] \\sim N \\left( \\left[\n          \\begin{array}{c}\n            0 \\\\ 0\n          \\end{array} \\right], \\left[\n          \\begin{array}{cc}\n            \\sigma_{u}^{2} & \\sigma_{uv} \\\\\n            \\sigma_{uv} & \\sigma_{v}^{2}\n          \\end{array} \\right] \\right)\n$$\n\n## Calculating variance and covariance {.midi}\n\nSuppose $Y_1 = a_1 X_1 + a_2 X_2 + a_3$ and $Y_2 = b_1 X_1 + b_2 X_2 + b_3$, where $X_1$ and $X_2$ are random variables and $a_i$ and $b_i$ are constants for $i = 1, 2, 3$. Then we know from probability theory that\n\n. . .\n\n$${\\small\\begin{aligned}Var(Y_1) & = a^{2}_{1} Var(X_1) + a^{2}_{2} Var(X_2) + 2 a_1 a_2 Cov(X_1,X_2) \\\\[10pt]\nCov(Y_1,Y_2) & = a_1 b_1 Var(X_1) + a_2 b_2 Var(X_2) + (a_1 b_2 + a_2 b_1) Cov(X_1,X_2)\\end{aligned}}$$\n\n::: callout-note\n*This extends beyond two random variables*\n:::\n\n. . .\n\nWe will use these properties to define the covariance structure of the observations in the model.\n\n## Calculating variance and covariance from the model\n\n$$\n\\begin{aligned}\n&Var(Y_{ij}) = \\sigma^2_u + t^2_j\\sigma^2_v + \\sigma^2 + 2t_j\\sigma_{uv} \\\\ \n&Cov(Y_{ij}, Y_{ik}) = \\sigma^2_u + t_jt_k\\sigma^2_v + (t_j + t_k)\\sigma_{uv}\n\\end{aligned}\n$$\n\nwhere $t_j$ is the $j^{th}$ time period\n\n::: question\nLet's see how these equations were derived.\n:::\n\n## Model estimates {.midi}\n\nGet the estimates for $\\sigma$, $\\sigma_u$, and $\\sigma_v$ from the model output\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nmodel <- lmer(MathAvgScore ~ charter + year08 + charter:year08 +\n                (year08|schoolid), data = charter)\ntidy(model) |> kable(digits = 3)\n```\n\n::: {.cell-output-display}\n\n\n|effect   |group    |term                    | estimate| std.error| statistic|\n|:--------|:--------|:-----------------------|--------:|---------:|---------:|\n|fixed    |NA       |(Intercept)             |  652.058|     0.284|  2291.998|\n|fixed    |NA       |charter1                |   -6.018|     0.866|    -6.953|\n|fixed    |NA       |year08                  |    1.197|     0.094|    12.698|\n|fixed    |NA       |charter1:year08         |    0.856|     0.314|     2.723|\n|ran_pars |schoolid |sd__(Intercept)         |    5.986|        NA|        NA|\n|ran_pars |schoolid |cor__(Intercept).year08 |    0.880|        NA|        NA|\n|ran_pars |schoolid |sd__year08              |    0.362|        NA|        NA|\n|ran_pars |Residual |sd__Observation         |    2.964|        NA|        NA|\n\n\n:::\n:::\n\n\n## Estimated variances and covariances\n\n**Within-school variance for 2008 time point** $(t_{i1} = 0)$\n\n$$\n\\begin{aligned}\n\\hat{Var}(Y_{i1}) &= 5.986^2 + 0^2*0.362^2 + 2.964^2 \\\\ &+ 2*0*(0.880 *5.986*0.362) \\\\\n& = \\mathbf{44.617}\n\\end{aligned}\n$$\n\n<br>\n\n. . .\n\n**Within-school covariance between 2008 and 2009** $(t_{i1} = 0, t_{i2} = 1)$\n\n$$\n\\begin{aligned}\n\\hat{Cov}(Y_{i1}, Y_{i2}) &= 5.986^2 + 0 * 1 * 0.362^2 \\\\ &+ (0 + 1)(0.880 *5.986*0.362) \\\\ \n& = \\mathbf{37.739}\n\\end{aligned}\n$$\n\n## Estimated covariance structure \n\n$$\n\\hat{Cov}(\\mathbf{Y}) =\\left[\n          \\begin{array}{ccc}\n            44.62 & 37.74 & 39.65\\\\\n           37.74 & 48.56& 41.81 \\\\\n           39.65 &41.81 &  52.77\\\\\n          \\end{array} \\right]$$\n\n## Correlation between observations\n\n$$Corr(Y_1, Y_2) = \\frac{Cov(Y_1, Y_2)}{\\sqrt{Var(Y_1)Var(Y_2)}}$$\n\n. . .\n\n$$\n\\begin{aligned}\n\\hat{Corr}(Y_{i1}, Y_{i2}) &= \\frac{37.74}{\\sqrt{44.62 * 48.56}} \\\\\n &= \\mathbf{0.811}\n\\end{aligned}\n$$\n\n::: question\nWrite the within-school correlation matrix.\n:::\n\n## Notes on covariance and correlation matrices\n\n::: incremental\n-   Often observe higher correlation between observations that are closer in time.\n\n    -   Is this the case in the MN schools data?\n\n-   Often observe similar variability in all time points.\n\n    -   Is this the case in the MN schools data?\n\n-   Two-level model structure is very flexible. Note that the time points do not need to be evenly spaced nor does each school have to have the same number of measurements.\n\n-   These concepts apply for all multilevel models not just those for longitudinal data.\n:::\n\n## Alternative covariance structures {.midi}\n\nThe standard covariance structure calculated from the multilevel model is useful in most situations. Sometimes, however, there may be a different covariance structure that better fits the data. A few alternatives are\n\n. . .\n\n**Unstructured**: Every variance and covariance term for observations with each level is a separate parameter and is uniquely estimated. No patterns among variances or correlations are assumed. Very flexible but requires the estimation of many parameters.\n\n. . .\n\n**Compound Symmetry**: Assume variance is constant across all Level One observations and correlation is constant across all pairs of Level One observations. Restrictive but few parameters to estimate.\n\n## Alternative covariance structures {.midi}\n\n**Autoregressive**: Assume constant variance across all time points, but correlation reduces in a systematic way such that closer time points are more correlated than those further apart.\n\n. . .\n\n**Toeplitz**: Similar to autoregressive but there is no imposed structure on the decreased correlation for time periods further apart.\n\n. . .\n\n**Heterogeneous variances**: Allows for equal variances across time points. Requires additional parameters to be estimated to allow for the unequal variances.\n\n## Trying different covariance structures {.midi}\n\n-   There is generally little difference in estimates of fixed effects, and the impact on standard errors tends to be minimal.\n\n-   If the primary analysis objective is inference and conclusions for fixed effects, it is often not worth spending too much time modeling different covariance structures.\n\n-   If the analysis is also greatly interested in the random effects and estimated variance components, then the covariance structure can make a difference and it is worth testing different structures.\n\n::: callout-tip\nSee [\"Fitting Linear Mixed Models in R\"](http://staff.pubhealth.ku.dk/~jufo/courses/rm2018/nlmePackage.pdf) for details on R packages and code for multilevel models with a predetermined covariance structure.\n:::\n\n## References\n",
    "supporting": [
      "16-covariance-structure_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {
      "include-after-body": [
        "\n<script>\n  // htmlwidgets need to know to resize themselves when slides are shown/hidden.\n  // Fire the \"slideenter\" event (handled by htmlwidgets.js) when the current\n  // slide changes (different for each slide format).\n  (function () {\n    // dispatch for htmlwidgets\n    function fireSlideEnter() {\n      const event = window.document.createEvent(\"Event\");\n      event.initEvent(\"slideenter\", true, true);\n      window.document.dispatchEvent(event);\n    }\n\n    function fireSlideChanged(previousSlide, currentSlide) {\n      fireSlideEnter();\n\n      // dispatch for shiny\n      if (window.jQuery) {\n        if (previousSlide) {\n          window.jQuery(previousSlide).trigger(\"hidden\");\n        }\n        if (currentSlide) {\n          window.jQuery(currentSlide).trigger(\"shown\");\n        }\n      }\n    }\n\n    // hookup for slidy\n    if (window.w3c_slidy) {\n      window.w3c_slidy.add_observer(function (slide_num) {\n        // slide_num starts at position 1\n        fireSlideChanged(null, w3c_slidy.slides[slide_num - 1]);\n      });\n    }\n\n  })();\n</script>\n\n"
      ]
    },
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}