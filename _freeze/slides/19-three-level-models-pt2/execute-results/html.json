{
  "hash": "4d466bbf1b59b0fd62ecd82b4ff3d228",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"Modeling data with three (or more) levels\"\nsubtitle: \"Part 2\"\ndate: \"03.27.24\"\ndate-format: \"MMM DD, YYYY\"\nauthor: \"Prof. Maria Tackett\"\nfooter: \"[ðŸ”— STA 310 - Spring 2024](https://sta310-sp24.netlify.app)\"\nlogo: \"../images/logo.png\"\nformat: \n  revealjs:\n    theme: slides.scss\n    slide-number: true\n    multiplex: false\n    transition: fade\n    incremental: false \n    chalkboard: true\nhtml-math-method:\n  method: mathjax\n  url: \"https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js\"\nexecute:\n  freeze: auto\n  echo: true\n  warning: false\n  message: false\nknitr:\n  opts_chunk: \n    R.options:      \n    width: 200\nbibliography: references.bib\n---\n\n\n\n::: {.cell layout-align=\"center\"}\n\n:::\n\n\n## Announcements\n\n-   Quiz 04 - due March 28 at noon\n\n    -   Covers readings and lectures March 4 - 20\n\n    -   Longitudinal modeling, Chapter 9 of *BMLR*\n\n-   Project 02\n\n    -   Presentations April 3 during lecture\n    -   Written report + GitHub repo due April 4 at 11:59pm\n\n-   Final project - Round 1 submission (optional) due April 25\n\n## Topics\n\n-   Write form of model for models with more than two levels\n\n-   Interpret fixed and random effects at each level\n\n-   See how three-level models are used in data analysis example\n\n::: callout-note\nThe notes are based on Chapter 10 of @roback2021beyond and @jones1991specifying unless otherwise noted.\n:::\n\n## Data: Housing prices in Southampton {.midi}\n\nThe data includes the price and characteristics for 918 houses sold between 1986 and 1991 in Southampton, England. The data were originally collected from a local real estate agency and were analyzed in @jones1991specifying. The primary variables of interest are\n\n-   **price**: Sales price in thousands of Â£\n-   **Age**: Age of the house\n-   **Bedrooms**: Number of bedrooms\n-   **House Type**: (semi-detached, detached, bungalow, terrace, flat)\n-   **Central heating**: Whether house has central heating (0: yes, 1: no)\n-   **Garage**: Number of garages (none, single, double)\n-   **Districts**: one of 34 districts\n-   **Half-years**: Half-year periods beginning the second half of 1986\n\n## Data structure\n\n![Portions of Figure 2b from @jones1991specifying](images/18/figure-2b.png){fig-align=\"center\" width=\"75%\"}\n\n::: callout-note\nYou can access the paper on [Canvas](https://canvas.duke.edu/courses/25310/files/folder/journal-articles?preview=1096423).The paper uses different symbols to represent parameters than what is in the textbook. The slides will follow the textbook.\n:::\n\n## Unconditional means model\n\n$$\n\\begin{aligned}\n&Y_{ijk} = \\alpha_0 + \\tilde{u}_i + u_{ij} + \\epsilon_{ijk} \\\\[5pt]\n&\\tilde{u}_i \\sim N(0, \\sigma^2_{\\tilde{u}}) \\hspace{8mm} u_{ij} \\sim N(0, \\sigma^2_{u}) \\hspace{8mm} \\epsilon_{ijk} \\sim N(0, \\sigma^2)\n\\end{aligned}\n$$\n\n. . .\n\n**Level One** (house within time)\n\n$Y_{ijk} = a_{ij} + \\epsilon_{ijk}, \\hspace{10mm} \\epsilon_{ijk} \\sim N(0, \\sigma^2)$\n\n. . .\n\n**Level Two** (time within district)\n\n$a_{ij} = a_i + u_{ij}, \\hspace{10mm} u_{ij} \\sim N(0, \\sigma^2_u)$\n\n. . .\n\n**Level Three** (district)\n\n$a_{i} = \\alpha_0 + \\tilde{u}_{i}, \\hspace{10mm} \\tilde{u}_{i} \\sim N(0, \\sigma^2_{\\tilde{u}})$\n\n## Model A\n\n::: columns\n::: {.column width=\"50%\"}\n![](images/18/fixed-effects-modela.png){fig-align=\"center\" width=\"80%\"}\n:::\n\n::: {.column width=\"50%\"}\n![Table 1 from Jones (1991)](images/18/random-effects-modela.png){fig-align=\"center\" width=\"80%\"}\n:::\n:::\n\n<br>\n\n::: question\nInterpret $\\hat{\\beta}_0$ (this is $\\alpha_0$ in our model notation)\n:::\n\n::: aside\nTable 1 from @jones1991specifying\n:::\n\n## Model A: Random effects {.midi}\n\n::: columns\n::: {.column width=\"50%\"}\n![](images/18/random-effects-modela.png){fig-align=\"center\"}\n:::\n\n::: {.column width=\"50%\"}\n-   About 29.8% of the variability in price is explained by differences between districts.\n-   About 21% of the variability in price is explained by differences between time periods within the same district.\n-   About 49.2% of the variability in price is explained by differences between houses in the same district sold in the same time period.\n:::\n:::\n\n## Model B: Covariates + random intercepts {.small}\n\n::: columns\n::: {.column width=\"50%\"}\n![](images/18/fixed-effects-modelb.png){fig-align=\"center\" width=\"80%\"}\n:::\n\n::: {.column width=\"50%\"}\n![](images/18/random-effects-modelb.png){fig-align=\"center\" width=\"80%\"}\n:::\n\nTable 1 from @jones1991specifying\n:::\n\n## Model B: Composite model\n\n$$\n\\begin{aligned}\nY_{ijk} &= \\alpha_0 + \\beta_1~age_{ijk} + \\beta_2~detached_{ijk} + \\beta_3 ~ bungalow_{ijk} \\\\ \n&+ \\beta_4 ~ terrace_{ijk} + \\beta_5~flat_{ijk}  + \\beta_6~bedrooms_{ijk} +\\beta_7~heating_{ijk}\\\\\n& + \\beta_8~single_{ijk} + \\beta_9 ~ double_{ijk} + [\\tilde{u}_i + u_{ij} + \\epsilon_{ijk}]\\\\[8pt]\n&\\tilde{u}_i \\sim N(0, \\sigma^2_{\\tilde{u}}) \\hspace{8mm} u_{ij} \\sim N(0, \\sigma^2_{u}) \\hspace{8mm} \\epsilon_{ijk} \\sim N(0, \\sigma^2)\n\\end{aligned}\n$$\n\n. . .\n\n::: question\nWrite the Level One, Level Two, Level Three models.\n:::\n\n## Model C: Additional random effect {.midi}\n\n::: columns\n::: {.column width=\"50%\"}\n![](images/18/fixed-effects-modelc.png){fig-align=\"center\" width=\"80%\"}\n:::\n\n::: {.column width=\"50%\"}\n![](images/18/random-effects-modelc.png){fig-align=\"center\" width=\"80%\"}\n\n::: question\n1.  How does this model differ from Model B?\n2.  Write the composite model.\n3.  Write the Level One, Level Two, and Level Three models.\n:::\n:::\n:::\n\n::: aside\nTable 1 from @jones1991specifying\n:::\n\n## Visualizing price by district over time\n\n::: columns\n::: {.column width=\"50%\"}\n![Figure 3 from @jones1991specifying](images/18/figure-3.png){fig-align=\"center\"}\n:::\n\n::: {.column width=\"50%\"}\n::: question\n1.  What do you observe from the plot?\n2.  What terms in the model can be understood from the plot?\n3.  How might you use this type of plot to support decisions you make in the analysis?\n:::\n:::\n:::\n\n## Price by district and bedrooms {.midi}\n\n::: columns\n::: {.column width=\"50%\"}\n![Figure 4 from @jones1991specifying](images/18/figure-4.png){fig-align=\"center\"}\n:::\n\n::: {.column width=\"50%\"}\n::: question\n1.  What do you observe from the plot?\n2.  What terms in the model can be understood from the plot?\n3.  How might you use this type of plot to support decisions you make in the analysis?\n:::\n\n<br>\n\n::: question\nHow does our understanding of the effect of bedrooms differ in this model compared to Model B?\n:::\n:::\n:::\n\n# Covariance structure of observations\n\n## Questions we want to answer\n\nLet's consider the covariance structure between *observations* at different levels.\n\n. . .\n\n-   What is the covariance structure of houses in the same district sold in different time periods? $(Y_{ij}, Y_{ij'})$\n\n. . .\n\n-   What is the covariance structure of houses in the same district sold in the same time period? $(Y_{ijk}, Y_{ijk'})$\n    -   How does this structure differ between Model B and Model C in @jones1991specifying?\n\n## Calculating variance and covariance\n\nSuppose $Y_1 = a_1 X_1 + a_2 X_2 + a_3$ and $Y_2 = b_1 X_1 + b_2 X_2 + b_3$ where $X_1$ and $X_2$ are random variables and $a_i$ and $b_i$ are constants for $i = 1, 2, 3$, then we know from probability theory that: $${\\small\\begin{aligned}Var(Y_1) & = a^{2}_{1} Var(X_1) + a^{2}_{2} Var(X_2) + 2 a_1 a_2 Cov(X_1,X_2) \\\\[10pt]\nCov(Y_1,Y_2) & = a_1 b_1 Var(X_1) + a_2 b_2 Var(X_2) + (a_1 b_2 + a_2 b_1) Cov(X_1,X_2)\\end{aligned}}$$\n\nWe will use these properties to define the covariance structure of the observations in the model.\n\n::: aside\nFrom [BMLR: Section 9.7.5](https://bookdown.org/roback/bookdown-BeyondMLR/ch-lon.html#optionalcov)\n:::\n\n## Covariance structure under Model B\n\nLet $Y_{ijk}$ be the sales price for the house $k$ in district $i$ sold in time period $j$, and $x_1, \\ldots, x_9$ be the house-level covariates. $$Y_{ijk} = \\alpha_0 + \\sum_{i = 1}^{9}\\beta_ix_i + [\\tilde{u}_i + u_{ij} + \\epsilon_{ijk}]$$ $$\\tilde{u}_i \\sim N(0, \\sigma_{\\tilde{u}}^2), \\hspace{5mm} u_{ij} \\sim N(0, \\sigma^2_{u}), \\hspace{5mm} \\epsilon_{ijk} \\sim N(0, \\sigma^2)$$\n\n## Variance and covariance derivations\n\n::: question\n1.  Use Model B to write the derivation of $Var(Y_{ijk})$, the variance of an individual observation.\n2.  Use Model B to write the derivation of $Cov(Y_{ijk}, Y_{ijk'})$, the covariance between houses sold in the same time period that are in the same district.\n3.  Write $Cov(\\mathbf{Y}_{ij})$, covariance matrix for houses sold in the same time period in the same district\n:::\n\n## References\n",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {
      "include-after-body": [
        "\n<script>\n  // htmlwidgets need to know to resize themselves when slides are shown/hidden.\n  // Fire the \"slideenter\" event (handled by htmlwidgets.js) when the current\n  // slide changes (different for each slide format).\n  (function () {\n    // dispatch for htmlwidgets\n    function fireSlideEnter() {\n      const event = window.document.createEvent(\"Event\");\n      event.initEvent(\"slideenter\", true, true);\n      window.document.dispatchEvent(event);\n    }\n\n    function fireSlideChanged(previousSlide, currentSlide) {\n      fireSlideEnter();\n\n      // dispatch for shiny\n      if (window.jQuery) {\n        if (previousSlide) {\n          window.jQuery(previousSlide).trigger(\"hidden\");\n        }\n        if (currentSlide) {\n          window.jQuery(currentSlide).trigger(\"shown\");\n        }\n      }\n    }\n\n    // hookup for slidy\n    if (window.w3c_slidy) {\n      window.w3c_slidy.add_observer(function (slide_num) {\n        // slide_num starts at position 1\n        fireSlideChanged(null, w3c_slidy.slides[slide_num - 1]);\n      });\n    }\n\n  })();\n</script>\n\n"
      ]
    },
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}