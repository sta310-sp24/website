{
  "hash": "91292a21b57e32d86e2e66bc611be2d9",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"Multilevel Generalized Linear Models\"\ndate: \"04.01.24\"\ndate-format: \"MMM DD, YYYY\"\nauthor: \"Prof. Maria Tackett\"\nfooter: \"[🔗 STA 310 - Spring 2024](https://sta310-sp24.netlify.app)\"\nlogo: \"../images/logo.png\"\nformat: \n  revealjs:\n    theme: slides.scss\n    slide-number: true\n    multiplex: false\n    transition: fade\n    incremental: false \n    chalkboard: true\nhtml-math-method:\n  method: mathjax\n  url: \"https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js\"\nexecute:\n  freeze: auto\n  echo: true\n  warning: false\n  message: false\nknitr:\n  opts_chunk: \n    R.options:      \n    width: 200\nbibliography: references.bib\n---\n\n\n\n::: {.cell layout-align=\"center\"}\n\n:::\n\n\n## Announcements\n\n-   Project 02\n\n    -   Presentations April 3 during lecture\n    -   Written report + GitHub repo due April 4 at 11:59pm\n\n-   Final project - Round 1 submission (optional) due April 25\n\n## Topics\n\n-   Exploratory data analysis for multilevel data with non-normal response variable\n\n-   Use a two-stage modeling approach to understand conclusions at each level\n\n-   Write Level One, Level Two and composite models for mutlilevel GLM\n\n-   Fit and interpret multilevel GLM\n\n::: aside\nThe notes are based on Chapter 11 of @roback2021beyond unless otherwise noted.\n:::\n\n## Data: College Basketball referees {.midi}\n\nToday's data set includes information on 4972 fouls in 340 NCAA basketball games from the Big Ten, ACC, and Big East conferences during the 2009-2010 season. The goal is to determine whether the data from this season support a conclusion from @anderson2009officiating that referees tend to \"even out\" foul calls in a game. The variables we'll focus on are\n\n-   **`foul.home`**: foul was called on home team (1: yes, 0: no)\n-   **`foul.diff`**: difference in fouls before current foul was called (home - visitor)\n-   **`game`**: Unique game ID number\n-   **`visitor`**: visiting team abbreviation\n-   **`home`**: home team abbreviation\n\nSee [BMLR: Section 11.3.1](https://bookdown.org/roback/bookdown-BeyondMLR/ch-GLMM.html#explore-glmm) for full codebook.\n\n## Data: College basketball referees {.midi}\n\n\n::: {.cell layout-align=\"center\"}\n::: {.cell-output-display}\n`````{=html}\n<table>\n <thead>\n  <tr>\n   <th style=\"text-align:right;\"> game </th>\n   <th style=\"text-align:left;\"> visitor </th>\n   <th style=\"text-align:left;\"> hometeam </th>\n   <th style=\"text-align:right;\"> foul.num </th>\n   <th style=\"text-align:right;\"> foul.home </th>\n   <th style=\"text-align:right;\"> foul.vis </th>\n   <th style=\"text-align:right;\"> foul.diff </th>\n   <th style=\"text-align:left;\"> foul.type </th>\n   <th style=\"text-align:right;\"> time </th>\n  </tr>\n </thead>\n<tbody>\n  <tr>\n   <td style=\"text-align:right;\"> 1 </td>\n   <td style=\"text-align:left;\"> IA </td>\n   <td style=\"text-align:left;\"> MN </td>\n   <td style=\"text-align:right;\"> 1 </td>\n   <td style=\"text-align:right;\"> 0 </td>\n   <td style=\"text-align:right;\"> 1 </td>\n   <td style=\"text-align:right;\"> 0 </td>\n   <td style=\"text-align:left;\"> Personal </td>\n   <td style=\"text-align:right;\"> 14.167 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 1 </td>\n   <td style=\"text-align:left;\"> IA </td>\n   <td style=\"text-align:left;\"> MN </td>\n   <td style=\"text-align:right;\"> 2 </td>\n   <td style=\"text-align:right;\"> 1 </td>\n   <td style=\"text-align:right;\"> 0 </td>\n   <td style=\"text-align:right;\"> -1 </td>\n   <td style=\"text-align:left;\"> Personal </td>\n   <td style=\"text-align:right;\"> 11.433 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 1 </td>\n   <td style=\"text-align:left;\"> IA </td>\n   <td style=\"text-align:left;\"> MN </td>\n   <td style=\"text-align:right;\"> 3 </td>\n   <td style=\"text-align:right;\"> 1 </td>\n   <td style=\"text-align:right;\"> 0 </td>\n   <td style=\"text-align:right;\"> 0 </td>\n   <td style=\"text-align:left;\"> Personal </td>\n   <td style=\"text-align:right;\"> 10.233 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 1 </td>\n   <td style=\"text-align:left;\"> IA </td>\n   <td style=\"text-align:left;\"> MN </td>\n   <td style=\"text-align:right;\"> 4 </td>\n   <td style=\"text-align:right;\"> 0 </td>\n   <td style=\"text-align:right;\"> 1 </td>\n   <td style=\"text-align:right;\"> 1 </td>\n   <td style=\"text-align:left;\"> Personal </td>\n   <td style=\"text-align:right;\"> 9.733 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 1 </td>\n   <td style=\"text-align:left;\"> IA </td>\n   <td style=\"text-align:left;\"> MN </td>\n   <td style=\"text-align:right;\"> 5 </td>\n   <td style=\"text-align:right;\"> 0 </td>\n   <td style=\"text-align:right;\"> 1 </td>\n   <td style=\"text-align:right;\"> 0 </td>\n   <td style=\"text-align:left;\"> Shooting </td>\n   <td style=\"text-align:right;\"> 7.767 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 1 </td>\n   <td style=\"text-align:left;\"> IA </td>\n   <td style=\"text-align:left;\"> MN </td>\n   <td style=\"text-align:right;\"> 6 </td>\n   <td style=\"text-align:right;\"> 0 </td>\n   <td style=\"text-align:right;\"> 1 </td>\n   <td style=\"text-align:right;\"> -1 </td>\n   <td style=\"text-align:left;\"> Shooting </td>\n   <td style=\"text-align:right;\"> 5.567 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 1 </td>\n   <td style=\"text-align:left;\"> IA </td>\n   <td style=\"text-align:left;\"> MN </td>\n   <td style=\"text-align:right;\"> 7 </td>\n   <td style=\"text-align:right;\"> 1 </td>\n   <td style=\"text-align:right;\"> 0 </td>\n   <td style=\"text-align:right;\"> -2 </td>\n   <td style=\"text-align:left;\"> Shooting </td>\n   <td style=\"text-align:right;\"> 2.433 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 1 </td>\n   <td style=\"text-align:left;\"> IA </td>\n   <td style=\"text-align:left;\"> MN </td>\n   <td style=\"text-align:right;\"> 8 </td>\n   <td style=\"text-align:right;\"> 1 </td>\n   <td style=\"text-align:right;\"> 0 </td>\n   <td style=\"text-align:right;\"> -1 </td>\n   <td style=\"text-align:left;\"> Offensive </td>\n   <td style=\"text-align:right;\"> 1.000 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 2 </td>\n   <td style=\"text-align:left;\"> MI </td>\n   <td style=\"text-align:left;\"> MIST </td>\n   <td style=\"text-align:right;\"> 1 </td>\n   <td style=\"text-align:right;\"> 0 </td>\n   <td style=\"text-align:right;\"> 1 </td>\n   <td style=\"text-align:right;\"> 0 </td>\n   <td style=\"text-align:left;\"> Shooting </td>\n   <td style=\"text-align:right;\"> 18.983 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 2 </td>\n   <td style=\"text-align:left;\"> MI </td>\n   <td style=\"text-align:left;\"> MIST </td>\n   <td style=\"text-align:right;\"> 2 </td>\n   <td style=\"text-align:right;\"> 1 </td>\n   <td style=\"text-align:right;\"> 0 </td>\n   <td style=\"text-align:right;\"> -1 </td>\n   <td style=\"text-align:left;\"> Personal </td>\n   <td style=\"text-align:right;\"> 17.200 </td>\n  </tr>\n</tbody>\n</table>\n\n`````\n:::\n:::\n\n\n## Modeling approach\n\n-   `foul.home` is a binary response variable (1: foul called on home team, 0: foul called on visiting team)\n\n    ✅ Use a generalized linear model, specifically one with the logit link function\n\n-   Data has a multilevel structure\n\n    -   Covariates at individual foul level and game level\n\n        ✅ Use a multilevel model\n\nWe will combine these and fit a **multilevel generalized linear model** with a logit link function\n\n# Exploratory data analysis\n\n## Exploratory data analysis\n\n**Univariate**\n\n-   Visualizations and summary statistics for Level One and Level Two variables\n\n**Bivariate**\n\n-   Segmented bar plots or mosaic plots for response vs. categorical predictors\n\n-   Conditional density plot for response vs. quantitative predictors\n\n-   Empirical logit plot for quantitative predictors\n\n    -   Is relationship reasonably linear?\n\n# Application exercise\n\n::: appex\n📋 [sta310-sp24.netlify.app/ae/lec-20-mutlievel-glm](https://sta310-sp24.netlify.app/ae/lec-20-mutlievel-glm.html)\n:::\n\n\n::: {.cell layout-align=\"center\"}\n::: {.cell-output-display}\n\n```{=html}\n<div class=\"countdown\" id=\"timer_de2e3f7e\" data-update-every=\"1\" tabindex=\"0\" style=\"right:0;bottom:0;margin:5%;\">\n<div class=\"countdown-controls\"><button class=\"countdown-bump-down\">&minus;</button><button class=\"countdown-bump-up\">&plus;</button></div>\n<code class=\"countdown-time\"><span class=\"countdown-digits minutes\">06</span><span class=\"countdown-digits colon\">:</span><span class=\"countdown-digits seconds\">00</span></code>\n</div>\n```\n\n:::\n:::\n\n\n## Logistic regression {.midi}\n\nStart with a logistic regression model treating all observations as independent\n\nQuick analysis to get initial intuition about research question sand important variables, not be used for final conclusions\n\n\n::: {.cell layout-align=\"center\"}\n::: {.cell-output-display}\n\n\n|term           | estimate| std.error| statistic| p.value|\n|:--------------|--------:|---------:|---------:|-------:|\n|(Intercept)    |   -0.103|     0.101|    -1.023|   0.306|\n|foul.diff      |   -0.077|     0.025|    -3.078|   0.002|\n|score.diff     |    0.020|     0.007|     3.012|   0.003|\n|lead.home      |   -0.093|     0.160|    -0.582|   0.560|\n|time           |   -0.013|     0.008|    -1.653|   0.098|\n|foul.diff:time |   -0.007|     0.003|    -2.485|   0.013|\n|lead.home:time |    0.022|     0.011|     1.957|   0.050|\n\n\n:::\n:::\n\n\n# Two-stage modeling\n\n## Two-stage modeling\n\nFor now, let's fit a model focusing on the question: **Do the data provide evidence that referees tend to \"even out\" fouls?**\n\nTo explore this, we will fit a model with the Level One predictor `foul.diff` using a two-stage modeling approach.\n\n. . .\n\n**Two-stage modeling approach**\n\n-   Fit a separate model of the association between `foul.diff` and `foul.home` for each game (Level One models)\n\n-   Fit models to explain game-to-game variability in the estimated slopes and intercepts (Level Two models)\n\n## Model set up\n\n-   $Y_{ij}$: 1 if $j^{th}$ foul in Game $i$ was called on home team; 0 otherwise.\n-   $p_{ij}$: True probability the $j^{th}$ foul in Game $i$ was called on home team\n\n$$\nY_{ij} \\sim Bernoulli(p_{ij})\n$$\n\n## Model Set Up\n\n**Level One models**\n\n$$\\log\\Big(\\frac{p_{ij}}{1 - p_{ij}}\\Big) = a_i + b_i ~ \\text{foul.diff}_{ij}$$ **Level Two models**\n\n$$a_i = \\alpha_0 + u_i\\hspace{20mm} b_i = \\beta_0 + v_i$$\n\n$$\\left[ \\begin{array}{c}\n            u_i \\\\ v_i\n          \\end{array}  \\right] \\sim N \\left( \\left[\n          \\begin{array}{c}\n            0 \\\\ 0\n          \\end{array} \\right], \\left[\n          \\begin{array}{cc}\n            \\sigma_u^{2} & \\sigma_{uv} \\\\\n            \\sigma_{uv} & \\sigma_{v}^{2}\n          \\end{array} \\right] \\right)$$\n\n## Level One Models\n\n\n::: {.cell layout-align=\"center\"}\n\n:::\n\n\n::: columns\n::: {.column width=\"50%\"}\n\n::: {.cell layout-align=\"center\"}\n::: {.cell-output-display}\n![](20-multilevel-glms_files/figure-revealjs/unnamed-chunk-6-1.png){fig-align='center' width=70%}\n:::\n\n::: {.cell-output-display}\n\n\n| alpha0| sigma2_u|\n|------:|--------:|\n| -0.301|  128.858|\n\n\n:::\n:::\n\n:::\n\n::: {.column width=\"50%\"}\n\n::: {.cell layout-align=\"center\"}\n::: {.cell-output-display}\n![](20-multilevel-glms_files/figure-revealjs/unnamed-chunk-7-1.png){fig-align='center' width=70%}\n:::\n\n::: {.cell-output-display}\n\n\n|  beta0| sigma2_v|\n|------:|--------:|\n| -3.328|   60.049|\n\n\n:::\n:::\n\n:::\n:::\n\n## Number of fouls per game\n\n\n::: {.cell layout-align=\"center\"}\n::: {.cell-output-display}\n![](20-multilevel-glms_files/figure-revealjs/unnamed-chunk-8-1.png){fig-align='center' width=70%}\n:::\n:::\n\n\n. . .\n\n⚠️ In the two-stage approach, games with 3 fouls are treated with equal weight as games with 20 + fouls\n\n# Unified multilevel model\n\n## Composite model\n\n**Composite model** $$\\log\\Big(\\frac{p_{ij}}{1 - p_{ij}}\\Big) = \\alpha_0 + \\beta_0 ~ \\text{foul.diff}_{ij} + [u_i + v_i ~ \\text{foul.diff}_{ij}]$$ $$\\left[ \\begin{array}{c}\n            u_i \\\\ v_i\n          \\end{array}  \\right] \\sim N \\left( \\left[\n          \\begin{array}{c}\n            0 \\\\ 0\n          \\end{array} \\right], \\left[\n          \\begin{array}{cc}\n            \\sigma_u^{2} & \\sigma_{uv} \\\\\n            \\sigma_{uv} & \\sigma_{v}^{2}\n          \\end{array} \\right] \\right)$$\n\n## Fit the model in R {.midi}\n\nUse the `glmer` function in the **lme4** package to fit multilevel GLMs.\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nmodel1 <- glmer(foul.home ~ foul.diff + (foul.diff|game), \n                data = basketball, family = binomial)\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\nboundary (singular) fit: see help('isSingular')\n```\n\n\n:::\n:::\n\n::: {.cell layout-align=\"center\"}\n::: {.cell-output-display}\n\n\n|effect   |group |term                       | estimate| std.error| statistic| p.value|\n|:--------|:-----|:--------------------------|--------:|---------:|---------:|-------:|\n|fixed    |NA    |(Intercept)                |   -0.157|     0.046|    -3.382|   0.001|\n|fixed    |NA    |foul.diff                  |   -0.285|     0.038|    -7.440|   0.000|\n|ran_pars |game  |sd__(Intercept)            |    0.542|        NA|        NA|      NA|\n|ran_pars |game  |cor__(Intercept).foul.diff |   -1.000|        NA|        NA|      NA|\n|ran_pars |game  |sd__foul.diff              |    0.035|        NA|        NA|      NA|\n\n\n:::\n:::\n\n\n# Boundary constraints\n\n## Boundary constraints {.midi}\n\n::: incremental\n-   The estimates of the parameters $\\alpha_0, \\beta_0, \\sigma_u, \\sigma_v, \\rho_{uv}$ are those that maximize the likelihood of observing the data\n\n-   The fixed effects, e.g., $\\alpha_0$ and $\\beta_0$, can take any values, but the terms associated with the error terms are constrained to a set of \"allowable\" values\n\n    -   $$\\sigma_u \\geq 0 \\hspace{10mm} \\sigma_v \\geq 0 \\hspace{10mm} -1 \\leq \\rho_{uv} \\leq 1$$\n\n-   Because of these boundaries, a \"constrained\" search is used to find the MLEs.\n\n-   The error message `\"## boundary (singular) fit\"`, means the estimate of one or more terms was set at the maximum (or minimum) allowable value, not the value it would've been if an unconstrained search were allowable\n:::\n\n## Illustrating boundary constraints\n\n::: columns\n::: {.column .fragment width=\"50%\" fragment-index=\"1\"}\nContour plots from a hypothetical likelihood $L(\\beta_0, \\sigma^2)$\n\n<br>\n\n\n::: {.cell layout-align=\"center\"}\n::: {.cell-output-display}\n![From BMLR Figure 10.14](20-multilevel-glms_files/figure-revealjs/boundary-1.png){fig-align='center' width=100%}\n:::\n:::\n\n:::\n\n::: {.column .fragment width=\"50%\" fragment-index=\"2\"}\n-   In the unconstrained search, the likelihood $L(\\beta_0, \\sigma^2)$ is maximized at $\\hat{\\beta}_0 = 4, \\hat{\\sigma}^2 = -2$\n\n-   In reality $\\sigma^2$ must be non-negative, so the search for the MLE is restricted to the region such that $\\sigma^2 \\geq 0$.\n\n-   The constrained likelihood is maximized at $\\hat{\\beta}_0 = 4, \\hat{\\sigma}^2 = 0$\n:::\n:::\n\n## Addressing boundary constraints\n\nAddress boundary constraints by reparameterizing the model\n\n-   Remove variance and/or correlation terms estimated at the boundary\n\n-   Reduce the number of parameters to be estimated by fixing the values of some parameters\n\n-   Apply transformation to covariates, such as centering variables, standardizing variables, or changing units. Extreme values, outliers, or highly correlated covariates can sometimes cause issues with MLEs.\n\n## Is it OK to use model that faces boundary constraints?\n\nBest to try to deal with boundary constraints, but you can sometimes leave the model as is if...\n\n-   You're not interested in estimating parameters with boundary issues\n\n-   Removing the parameters does not impact conclusions about the variables of interest\n\n## Original model {.midi}\n\n\n::: {.cell layout-align=\"center\"}\n::: {.cell-output-display}\n\n\n|effect   |group |term                       | estimate| std.error| statistic| p.value|\n|:--------|:-----|:--------------------------|--------:|---------:|---------:|-------:|\n|fixed    |NA    |(Intercept)                |   -0.157|     0.046|    -3.382|   0.001|\n|fixed    |NA    |foul.diff                  |   -0.285|     0.038|    -7.440|   0.000|\n|ran_pars |game  |sd__(Intercept)            |    0.542|        NA|        NA|      NA|\n|ran_pars |game  |cor__(Intercept).foul.diff |   -1.000|        NA|        NA|      NA|\n|ran_pars |game  |sd__foul.diff              |    0.035|        NA|        NA|      NA|\n\n\n:::\n:::\n\n\n::: question\n1.  Which term(s) should we remove to try to address boundary constraint?\n2.  Refit the model with these terms removed. 3. Which model do you choose? Explain.\n:::\n\n\n::: {.cell layout-align=\"center\"}\n::: {.cell-output-display}\n\n```{=html}\n<div class=\"countdown\" id=\"timer_efb4e720\" data-update-every=\"1\" tabindex=\"0\" style=\"right:0;bottom:0;margin:5%;\">\n<div class=\"countdown-controls\"><button class=\"countdown-bump-down\">&minus;</button><button class=\"countdown-bump-up\">&plus;</button></div>\n<code class=\"countdown-time\"><span class=\"countdown-digits minutes\">04</span><span class=\"countdown-digits colon\">:</span><span class=\"countdown-digits seconds\">00</span></code>\n</div>\n```\n\n:::\n:::\n\n\n## Interpret model coefficients\n\nInterpret the following coefficients in the selected model (if applicable):\n\n-   $\\hat{\\alpha}_0$\n\n-   $\\hat{\\beta}_0$\n\n-   $\\hat{\\sigma}_u$\n\n-   $\\hat{\\sigma}_v$\n\n-   $\\hat{\\rho}_{uv}$\n\n## Looking ahead\n\nSo far we've only considered random effects within a nested structure, but sometimes we may want to consider random effects that aren't nested.\n\n-   For example, we want to consider a random effect for the home team, but home team is not nested within game (since teams can be the home team for multiple games)\n\n-   We will deal with this using **crossed random effects**\n\n## References\n",
    "supporting": [
      "20-multilevel-glms_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {
      "include-in-header": [
        "<link href=\"../site_libs/countdown-0.4.0/countdown.css\" rel=\"stylesheet\" />\n<script src=\"../site_libs/countdown-0.4.0/countdown.js\"></script>\n"
      ],
      "include-after-body": [
        "\n<script>\n  // htmlwidgets need to know to resize themselves when slides are shown/hidden.\n  // Fire the \"slideenter\" event (handled by htmlwidgets.js) when the current\n  // slide changes (different for each slide format).\n  (function () {\n    // dispatch for htmlwidgets\n    function fireSlideEnter() {\n      const event = window.document.createEvent(\"Event\");\n      event.initEvent(\"slideenter\", true, true);\n      window.document.dispatchEvent(event);\n    }\n\n    function fireSlideChanged(previousSlide, currentSlide) {\n      fireSlideEnter();\n\n      // dispatch for shiny\n      if (window.jQuery) {\n        if (previousSlide) {\n          window.jQuery(previousSlide).trigger(\"hidden\");\n        }\n        if (currentSlide) {\n          window.jQuery(currentSlide).trigger(\"shown\");\n        }\n      }\n    }\n\n    // hookup for slidy\n    if (window.w3c_slidy) {\n      window.w3c_slidy.add_observer(function (slide_num) {\n        // slide_num starts at position 1\n        fireSlideChanged(null, w3c_slidy.slides[slide_num - 1]);\n      });\n    }\n\n  })();\n</script>\n\n"
      ]
    },
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}