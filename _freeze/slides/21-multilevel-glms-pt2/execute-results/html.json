{
  "hash": "1e4db5b6ebf0d4b025aa7ad5247d0b18",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"Multilevel Generalized Linear Models\"\nsubtitle: \"Crossed random effects\"\ndate: \"04.10.24\"\ndate-format: \"MMM DD, YYYY\"\nauthor: \"Prof. Maria Tackett\"\nfooter: \"[ðŸ”— STA 310 - Spring 2024](https://sta310-sp24.netlify.app)\"\nlogo: \"../images/logo.png\"\nformat: \n  revealjs:\n    theme: slides.scss\n    slide-number: true\n    multiplex: false\n    transition: fade\n    incremental: false \n    chalkboard: true\nhtml-math-method:\n  method: mathjax\n  url: \"https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js\"\nexecute:\n  freeze: auto\n  echo: true\n  warning: false\n  message: false\nknitr:\n  opts_chunk: \n    R.options:      \n    width: 200\nbibliography: references.bib\n---\n\n\n\n::: {.cell layout-align=\"center\"}\n\n:::\n\n\n## Announcements\n\n-   HW 05 due today at 11:59pm\n-   Final project\n    -   Round 1 submission (optional) due April 25\n\n    -   Final submission due May 2\n\n## Topics\n\n-   Fit and interpret multilevel GLM\n\n-   Understand crossed random effects and incorporate them in the multilevel model\n\n::: aside\nThe notes are based on Chapter 11 of @roback2021beyond unless otherwise noted.\n:::\n\n## Data: College Basketball referees {.midi}\n\nToday's data set includes information on 4972 fouls in 340 NCAA basketball games from the Big Ten, ACC, and Big East conferences during the 2009-2010 season. The goal is to determine whether the data from this season support a conclusion from @anderson2009officiating that referees tend to \"even out\" foul calls in a game. The variables we'll focus on are\n\n-   **`foul.home`**: foul was called on home team (1: yes, 0: no)\n-   **`foul.diff`**: difference in fouls before current foul was called (home - visitor)\n-   **`game`**: Unique game ID number\n-   **`visitor`**: visiting team abbreviation\n-   **`home`**: home team abbreviation\n\nSee [BMLR: Section 11.3.1](https://bookdown.org/roback/bookdown-BeyondMLR/ch-GLMM.html#explore-glmm) for full codebook.\n\n## Data: College basketball referees\n\n\n::: {.cell layout-align=\"center\"}\n::: {.cell-output-display}\n`````{=html}\n<table>\n <thead>\n  <tr>\n   <th style=\"text-align:right;\"> game </th>\n   <th style=\"text-align:left;\"> visitor </th>\n   <th style=\"text-align:left;\"> hometeam </th>\n   <th style=\"text-align:right;\"> foul.num </th>\n   <th style=\"text-align:right;\"> foul.home </th>\n   <th style=\"text-align:right;\"> foul.vis </th>\n   <th style=\"text-align:right;\"> foul.diff </th>\n   <th style=\"text-align:left;\"> foul.type </th>\n   <th style=\"text-align:right;\"> time </th>\n  </tr>\n </thead>\n<tbody>\n  <tr>\n   <td style=\"text-align:right;\"> 1 </td>\n   <td style=\"text-align:left;\"> IA </td>\n   <td style=\"text-align:left;\"> MN </td>\n   <td style=\"text-align:right;\"> 1 </td>\n   <td style=\"text-align:right;\"> 0 </td>\n   <td style=\"text-align:right;\"> 1 </td>\n   <td style=\"text-align:right;\"> 0 </td>\n   <td style=\"text-align:left;\"> Personal </td>\n   <td style=\"text-align:right;\"> 14.167 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 1 </td>\n   <td style=\"text-align:left;\"> IA </td>\n   <td style=\"text-align:left;\"> MN </td>\n   <td style=\"text-align:right;\"> 2 </td>\n   <td style=\"text-align:right;\"> 1 </td>\n   <td style=\"text-align:right;\"> 0 </td>\n   <td style=\"text-align:right;\"> -1 </td>\n   <td style=\"text-align:left;\"> Personal </td>\n   <td style=\"text-align:right;\"> 11.433 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 1 </td>\n   <td style=\"text-align:left;\"> IA </td>\n   <td style=\"text-align:left;\"> MN </td>\n   <td style=\"text-align:right;\"> 3 </td>\n   <td style=\"text-align:right;\"> 1 </td>\n   <td style=\"text-align:right;\"> 0 </td>\n   <td style=\"text-align:right;\"> 0 </td>\n   <td style=\"text-align:left;\"> Personal </td>\n   <td style=\"text-align:right;\"> 10.233 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 1 </td>\n   <td style=\"text-align:left;\"> IA </td>\n   <td style=\"text-align:left;\"> MN </td>\n   <td style=\"text-align:right;\"> 4 </td>\n   <td style=\"text-align:right;\"> 0 </td>\n   <td style=\"text-align:right;\"> 1 </td>\n   <td style=\"text-align:right;\"> 1 </td>\n   <td style=\"text-align:left;\"> Personal </td>\n   <td style=\"text-align:right;\"> 9.733 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 1 </td>\n   <td style=\"text-align:left;\"> IA </td>\n   <td style=\"text-align:left;\"> MN </td>\n   <td style=\"text-align:right;\"> 5 </td>\n   <td style=\"text-align:right;\"> 0 </td>\n   <td style=\"text-align:right;\"> 1 </td>\n   <td style=\"text-align:right;\"> 0 </td>\n   <td style=\"text-align:left;\"> Shooting </td>\n   <td style=\"text-align:right;\"> 7.767 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 1 </td>\n   <td style=\"text-align:left;\"> IA </td>\n   <td style=\"text-align:left;\"> MN </td>\n   <td style=\"text-align:right;\"> 6 </td>\n   <td style=\"text-align:right;\"> 0 </td>\n   <td style=\"text-align:right;\"> 1 </td>\n   <td style=\"text-align:right;\"> -1 </td>\n   <td style=\"text-align:left;\"> Shooting </td>\n   <td style=\"text-align:right;\"> 5.567 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 1 </td>\n   <td style=\"text-align:left;\"> IA </td>\n   <td style=\"text-align:left;\"> MN </td>\n   <td style=\"text-align:right;\"> 7 </td>\n   <td style=\"text-align:right;\"> 1 </td>\n   <td style=\"text-align:right;\"> 0 </td>\n   <td style=\"text-align:right;\"> -2 </td>\n   <td style=\"text-align:left;\"> Shooting </td>\n   <td style=\"text-align:right;\"> 2.433 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 1 </td>\n   <td style=\"text-align:left;\"> IA </td>\n   <td style=\"text-align:left;\"> MN </td>\n   <td style=\"text-align:right;\"> 8 </td>\n   <td style=\"text-align:right;\"> 1 </td>\n   <td style=\"text-align:right;\"> 0 </td>\n   <td style=\"text-align:right;\"> -1 </td>\n   <td style=\"text-align:left;\"> Offensive </td>\n   <td style=\"text-align:right;\"> 1.000 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 2 </td>\n   <td style=\"text-align:left;\"> MI </td>\n   <td style=\"text-align:left;\"> MIST </td>\n   <td style=\"text-align:right;\"> 1 </td>\n   <td style=\"text-align:right;\"> 0 </td>\n   <td style=\"text-align:right;\"> 1 </td>\n   <td style=\"text-align:right;\"> 0 </td>\n   <td style=\"text-align:left;\"> Shooting </td>\n   <td style=\"text-align:right;\"> 18.983 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 2 </td>\n   <td style=\"text-align:left;\"> MI </td>\n   <td style=\"text-align:left;\"> MIST </td>\n   <td style=\"text-align:right;\"> 2 </td>\n   <td style=\"text-align:right;\"> 1 </td>\n   <td style=\"text-align:right;\"> 0 </td>\n   <td style=\"text-align:right;\"> -1 </td>\n   <td style=\"text-align:left;\"> Personal </td>\n   <td style=\"text-align:right;\"> 17.200 </td>\n  </tr>\n</tbody>\n</table>\n\n`````\n:::\n:::\n\n\n## Model 1: Composite model\n\n\\\n$$\\log\\Big(\\frac{p_{ij}}{1 - p_{ij}}\\Big) = \\alpha_0 + \\beta_0 ~ \\text{foul.diff}_{ij} + [u_i + v_i ~ \\text{foul.diff}_{ij}]$$ $$\\left[ \\begin{array}{c}\n            u_i \\\\ v_i\n          \\end{array}  \\right] \\sim N \\left( \\left[\n          \\begin{array}{c}\n            0 \\\\ 0\n          \\end{array} \\right], \\left[\n          \\begin{array}{cc}\n            \\sigma_u^{2} & \\sigma_{uv} \\\\\n            \\sigma_{uv} & \\sigma_{v}^{2}\n          \\end{array} \\right] \\right)$$\n\n## Model 1 in R {.midi}\n\nUse the `glmer` function in the **lme4** package to fit multilevel GLMs.\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nmodel1 <- glmer(foul.home ~ foul.diff + (foul.diff|game), \n                data = basketball, family = binomial)\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\nboundary (singular) fit: see help('isSingular')\n```\n\n\n:::\n:::\n\n\n<br>\n\n\n::: {.cell layout-align=\"center\"}\n::: {.cell-output-display}\n\n\n|effect   |group |term                       | estimate| std.error| statistic| p.value|\n|:--------|:-----|:--------------------------|--------:|---------:|---------:|-------:|\n|fixed    |NA    |(Intercept)                |   -0.157|     0.046|    -3.382|   0.001|\n|fixed    |NA    |foul.diff                  |   -0.285|     0.038|    -7.440|   0.000|\n|ran_pars |game  |sd__(Intercept)            |    0.542|        NA|        NA|      NA|\n|ran_pars |game  |cor__(Intercept).foul.diff |   -1.000|        NA|        NA|      NA|\n|ran_pars |game  |sd__foul.diff              |    0.035|        NA|        NA|      NA|\n\n\n:::\n:::\n\n\n## Boundary constraints {.midi}\n\n-   The estimates of the parameters $\\alpha_0, \\beta_0, \\sigma_u, \\sigma_v, \\rho_{uv}$ are those that maximize the likelihood of observing the data\n\n-   The fixed effects, e.g., $\\alpha_0$ and $\\beta_0$, can take any values, but the terms associated with the error terms are constrained to a set of \"allowable\" values\n\n$$\\sigma_u \\geq 0 \\hspace{10mm} \\sigma_v \\geq 0 \\hspace{10mm} -1 \\leq \\rho_{uv} \\leq 1$$\n\n-   Because of these boundaries, a \"constrained\" search is used to find the MLEs.\n\n-   The warning message `\"## boundary (singular) fit\"`, means the estimate of one or more terms was set at the maximum (or minimum) allowable value, not the value it would've been if an unconstrained search were allowable\n\n## Illustrating boundary constraints\n\n::: columns\n::: {.column .fragment width=\"50%\" fragment-index=\"1\"}\nContour plots from a hypothetical likelihood $L(\\beta_0, \\sigma^2)$\n\n<br>\n\n\n::: {.cell layout-align=\"center\"}\n::: {.cell-output-display}\n![From BMLR Figure 10.14](21-multilevel-glms-pt2_files/figure-revealjs/boundary-1.png){fig-align='center' width=100%}\n:::\n:::\n\n:::\n\n::: {.column .fragment width=\"50%\" fragment-index=\"2\"}\n-   In the unconstrained search, the likelihood $L(\\beta_0, \\sigma^2)$ is maximized at $\\hat{\\beta}_0 = 4, \\hat{\\sigma}^2 = -2$\n\n-   In reality $\\sigma^2$ must be non-negative, so the search for the MLE is restricted to the region such that $\\sigma^2 \\geq 0$.\n\n-   The constrained likelihood is maximized at $\\hat{\\beta}_0 = 4, \\hat{\\sigma}^2 = 0$\n:::\n:::\n\n## Model 2: Refit model without $\\rho_{uv}$\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nmodel2 <- glmer(foul.home ~ foul.diff + (1|game) + (0 + foul.diff|game), \n                data = basketball, family = binomial)\n```\n:::\n\n\n<br>\n\n\n::: {.cell layout-align=\"center\"}\n::: {.cell-output-display}\n\n\n|effect   |group  |term            | estimate| std.error| statistic| p.value|\n|:--------|:------|:---------------|--------:|---------:|---------:|-------:|\n|fixed    |NA     |(Intercept)     |   -0.187|     0.044|    -4.213|       0|\n|fixed    |NA     |foul.diff       |   -0.272|     0.040|    -6.713|       0|\n|ran_pars |game   |sd__(Intercept) |    0.518|        NA|        NA|      NA|\n|ran_pars |game.1 |sd__foul.diff   |    0.043|        NA|        NA|      NA|\n\n\n:::\n:::\n\n\n## Model 2\n\n\\\n$$\\begin{aligned}\\log\\Big(\\frac{p_{ij}}{1 - p_{ij}}\\Big) &= \\alpha_0 + \\beta_0 ~ \\text{foul.diff}_{ij} + [u_i + v_i ~ \\text{foul.diff}_{ij}] \\\\\n&u_i \\sim N(0, \\sigma^2_u) \\hspace{10mm} v_i \\sim N(0, \\sigma^2_v)\\end{aligned}$$\n\n::: incremental\n-   $\\hat{\\alpha}_0$: The odds of a foul on the home team when the number of fouls is even is expected to be 0.829, $e^{-0.187}$.\n\n-   $\\hat{\\beta}_0$: When the foul differential increases by 1, the odds of a foul on the home team is expected to decrease by 23.8% (multiply by $e^{-0.272}$).\n\n-   $\\hat{\\sigma}_u$: The variance in the log-odds intercepts between games after adjusting for foul differential is $0.518^2 = 0.268$.\n\n-   $\\hat{\\sigma}_v$: The variance in the effect on the log-odds of foul differential between games is $0.043^2 = 0.002$.\n\n-   $\\hat{\\rho}_{uv}$: The correlation between the game-to-game variability in the slopes and intercepts (not included in this model)\n:::\n\n# Crossed random effects\n\n## Crossed random effects\n\n::: incremental\n-   The Level Two covariates are the home team and visiting team\n\n-   There is some evidence in the EDA that there may be differences in the probability of a foul depending on the home team\n\n-   We will account for this difference by treating home team and visiting team as random effects in the model\n\n    -   *Issue*: Home and visiting team are not nested within game, since a single home and visiting team can be in multiple games\n\n-   The random effects for game, home team, and visiting team are **crossed random effects**\n:::\n\n## Notation\n\n$Y_{i[gh]j}$: Random variable indicating whether the $j^{th}$ foul in Game $i$ was called on home team $h$ instead of visiting team $g$\n\n$$Y_{i[gh]j} \\sim Bernoulli(p_{i[gh]j})$$\n\n<br>\n\nwhere $p_{i[gh]j}$ is the true probability a foul in Game $i$ was called on home team $h$ instead of visiting team $g$\n\n## Model 3: Models by level\n\n**Level One**\n\n$$\\log\\Big(\\frac{p_{i[gh]j}}{1 - p_{i[gh]j}}\\Big) = a_i + b_i ~ \\text{foul.diff}_{ij}$$\n\n. . .\n\n**Level Two**\n\n$$\\begin{aligned}&a_i = \\alpha_0 + u_i + v_h + w_g\\\\\n&\\beta_i = \\beta_0\\end{aligned}$$\n\n<br>\n\n$$u_i \\sim N(0, \\sigma^2_u) \\hspace{10mm} v_h \\sim N(0, \\sigma^2_v) \\hspace{10mm} w_g \\sim N(0, \\sigma^2_w)$$\n\n## Model 3: Composite model {.midi}\n\n$$\\log\\Big(\\frac{p_{i[gh]j}}{1 - p_{i[gh]j}}\\Big) = \\alpha_0 + \\beta_0 ~ \\text{foul.diff}_{ij} + [u_i + v_h + w_g]$$\n\n$$u_i \\sim N(0, \\sigma^2_u) \\hspace{10mm} v_h \\sim N(0, \\sigma^2_v) \\hspace{10mm} w_g \\sim N(0, \\sigma^2_w)$$\n\n. . .\n\n**Why add additional random effects?**\n\n-   Get more precise estimates of fixed effects\n\n-   Can make comparisons of game-to-game and team-to-team variability\n\n-   Can get estimated random effects for each team and use them to compare odds of a foul on the home team for different teams\n\n## Model 3 in R\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nmodel3 <- glmer(foul.home ~ foul.diff + \n                  (1|game) + (1|hometeam) + (1 | visitor),\n               data = basketball, family = binomial)\n```\n:::\n\n::: {.cell layout-align=\"center\"}\n::: {.cell-output-display}\n\n\n|effect   |group    |term            | estimate| std.error| statistic| p.value|\n|:--------|:--------|:---------------|--------:|---------:|---------:|-------:|\n|fixed    |NA       |(Intercept)     |   -0.188|     0.063|    -2.967|   0.003|\n|fixed    |NA       |foul.diff       |   -0.264|     0.039|    -6.795|   0.000|\n|ran_pars |game     |sd__(Intercept) |    0.414|        NA|        NA|      NA|\n|ran_pars |hometeam |sd__(Intercept) |    0.261|        NA|        NA|      NA|\n|ran_pars |visitor  |sd__(Intercept) |    0.152|        NA|        NA|      NA|\n\n\n:::\n:::\n\n\n## Model 3 coefficients {.midi}\n\n\n::: {.cell layout-align=\"center\"}\n::: {.cell-output-display}\n\n\n|effect   |group    |term            | estimate| std.error| statistic| p.value|\n|:--------|:--------|:---------------|--------:|---------:|---------:|-------:|\n|fixed    |NA       |(Intercept)     |   -0.188|     0.063|    -2.967|   0.003|\n|fixed    |NA       |foul.diff       |   -0.264|     0.039|    -6.795|   0.000|\n|ran_pars |game     |sd__(Intercept) |    0.414|        NA|        NA|      NA|\n|ran_pars |hometeam |sd__(Intercept) |    0.261|        NA|        NA|      NA|\n|ran_pars |visitor  |sd__(Intercept) |    0.152|        NA|        NA|      NA|\n\n\n:::\n:::\n\n\n. . .\n\n::: question\nAbout what percent of the variability in the intercepts is due to...\n\n-   game-to-game differences?\n-   differences among home teams?\n-   differences among visiting teams?\n:::\n\n## Keep the crossed random effects? {.midi}\n\n-   Given a large proportion of the variability in the intercepts is explained by game-to-game differences, we can assess if the random effects for home team and visiting team are providing useful information.\n\n-   To do so, we will compare the following models\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nmodela <-  glmer(foul.home ~ foul.diff + (1|game), \n                 data = basketball, family = binomial)\n\nmodelb <- glmer(foul.home ~ foul.diff + \n                  (1|game) + (1 | hometeam) + (1|visitor),\n                data = basketball, family = binomial)\n```\n:::\n\n\n::: question\n-   What parameters are being tested?\n\n-   Write the null and alternative hypotheses.\n:::\n\n## Keep the crossed random effects?\n\nWe can use the following methods to assess if it is useful to keep the crossed random effects in the model:\n\n-   Parametric bootstrap confidence intervals\n\n-   Compare models with and without the random effects using AIC or BIC\n\n. . .\n\nAdditional methods to use with caution:\n\n-   Likelihood ratio test based on $\\chi^2$ (unreliable when testing random effects)\n\n-   Parametric bootstrap likelihood ratio test (can have very long computational time)\n\n## Parametric bootstrap CI\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nset.seed(310)\nconfint(modelb, method = \"boot\", oldNames = FALSE) |>\n  kable(digits = 3)\n```\n\n::: {.cell-output-display}\n\n\n|                             |  2.5 %| 97.5 %|\n|:----------------------------|------:|------:|\n|sd_(Intercept)&#124;game     |  0.281|  0.493|\n|sd_(Intercept)&#124;hometeam |  0.137|  0.362|\n|sd_(Intercept)&#124;visitor  |  0.000|  0.255|\n|(Intercept)                  | -0.306| -0.069|\n|foul.diff                    | -0.299| -0.227|\n\n\n:::\n:::\n\n\n## AIC and BIC\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nglance(modela) |> kable(digits = 3)\n```\n\n::: {.cell-output-display}\n\n\n| nobs| sigma|   logLik|     AIC|      BIC| deviance| df.residual|\n|----:|-----:|--------:|-------:|--------:|--------:|-----------:|\n| 4972|     1| -3393.27| 6792.54| 6812.075| 6397.136|        4969|\n\n\n:::\n\n```{.r .cell-code}\nglance(modelb) |> kable(digits = 3)\n```\n\n::: {.cell-output-display}\n\n\n| nobs| sigma|    logLik|      AIC|      BIC| deviance| df.residual|\n|----:|-----:|---------:|--------:|--------:|--------:|-----------:|\n| 4972|     1| -3385.233| 6780.466| 6813.024| 6420.534|        4967|\n\n\n:::\n:::\n\n\n## Full model {.midi}\n\n$$\\begin{aligned}\\log\\Big(\\frac{p_{i[gh]j}}{1 - p_{i[gh]j}}\\Big) &= \\alpha_0 + \\beta_0 ~ \\text{foul.diff}_{ij} + \\gamma_0 ~\\text{score.diff}_{ij} +  \\\\ \n&+ \\phi_0 ~ \\text{time}_{ij} + \\kappa_0 ~ \\text{offensive}_{ij} + \\lambda_0 ~ \\text{personal}_{ij} \\\\ \n&+ \\mu_0 ~ \\text{foul.diff}_{ij}\\text{:offensive}_{ij} + \\nu_0 ~ \\text{foul.diff}_{ij}\\text{:personal}_{ij} \\\\ \n& + \\omega_0 ~ \\text{foul.diff}_{ij}\\text{:time_}_{ij} \\\\ \n&+ [u_i + v_h + w_g]\\end{aligned}$$ $$u_i \\sim N(0, \\sigma^2_u) \\hspace{10mm} v_h \\sim N(0, \\sigma^2_v) \\hspace{10mm} w_g \\sim N(0, \\sigma^2_w)$$\n\n. . .\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nfull_model <- glmer(foul.home ~ foul.diff + score.diff + time + \n                      offensive + personal + foul.diff:offensive + \n                      foul.diff:personal + foul.diff:time + \n                      (1|game) + (1|hometeam) + (1|visitor),\n  family = binomial, data = basketball)\n```\n:::\n\n\n::: aside\nSimilar to model from [Section 11.7](https://bookdown.org/roback/bookdown-BeyondMLR/ch-GLMM.html#sec:finalmodel-glmm) of @roback2021beyond\n:::\n\n## Full model\n\n::: small\n\n::: {.cell layout-align=\"center\"}\n::: {.cell-output-display}\n\n\n|effect   |group    |term                | estimate| std.error| statistic| p.value|\n|:--------|:--------|:-------------------|--------:|---------:|---------:|-------:|\n|fixed    |NA       |(Intercept)         |   -0.336|     0.100|    -3.347|   0.001|\n|fixed    |NA       |foul.diff           |   -0.169|     0.046|    -3.697|   0.000|\n|fixed    |NA       |score.diff          |    0.035|     0.006|     6.238|   0.000|\n|fixed    |NA       |time                |    0.005|     0.006|     0.854|   0.393|\n|fixed    |NA       |offensive           |   -0.077|     0.111|    -0.692|   0.489|\n|fixed    |NA       |personal            |    0.073|     0.065|     1.115|   0.265|\n|fixed    |NA       |foul.diff:offensive |   -0.102|     0.054|    -1.893|   0.058|\n|fixed    |NA       |foul.diff:personal  |   -0.056|     0.032|    -1.755|   0.079|\n|fixed    |NA       |foul.diff:time      |   -0.009|     0.003|    -2.766|   0.006|\n|ran_pars |game     |sd__(Intercept)     |    0.425|        NA|        NA|      NA|\n|ran_pars |hometeam |sd__(Intercept)     |    0.278|        NA|        NA|      NA|\n|ran_pars |visitor  |sd__(Intercept)     |    0.208|        NA|        NA|      NA|\n\n\n:::\n:::\n\n:::\n\n## Conclusions from full model\n\n::: question\nBased on the full model, what are your conclusions about the factors that impact the odds of a foul on the home team?\n\nSee [Section 11.3.1](https://bookdown.org/roback/bookdown-BeyondMLR/ch-GLMM.html#explore-glmm) of @roback2021beyond or full codebook.\n:::\n\n# Estimated random effects\n\n## Estimated random effects for each team\n\n-   We will use the full model to get the estimated random effect for each team.\n\n-   These are **empirical Bayes estimates** (\"shrinkage estimates\").\n\n    -   Combine individual-specific information with information from all teams\n    -   \"Shrinks\" the individual estimates toward the group averages\n\n::: aside\nSee @liu2021use on [Canvas](https://canvas.duke.edu/courses/25310/files/folder/journal-articles?preview=1170605) for more detail on empirical Bayes estimation.\n:::\n\n## Estimated random effects for each team {.small}\n\nWe can get these effects using the **`ranef`** function in the lmer R package.\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nreffect_game <- ranef(full_model)$game |> select(`(Intercept)`) |> pull()\nreffect_home <- ranef(full_model)$hometeam |> select(`(Intercept)`) |> pull()\nreffect_visitor <- ranef(full_model)$visitor |> select(`(Intercept)`) |> pull()\nteam_names <- rownames(ranef(full_model)$visitor)\nreffect_team <- tibble(team = team_names, \n                       reffect_home = reffect_home,\n                     reffect_visitor = reffect_visitor)\n```\n:::\n\n\n. . .\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nreffect_team |>\n  slice(1:5)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 5 Ã— 3\n  team   reffect_home reffect_visitor\n  <chr>         <dbl>           <dbl>\n1 BC          -0.0623          0.0296\n2 CIN          0.291          -0.0827\n3 CLEM        -0.174          -0.126 \n4 CT          -0.274           0.0756\n5 DEPAUL       0.439          -0.281 \n```\n\n\n:::\n:::\n\n\n## Distribution of random home team effects\n\n\n::: {.cell layout-align=\"center\"}\n::: {.cell-output-display}\n![](21-multilevel-glms-pt2_files/figure-revealjs/unnamed-chunk-17-1.png){fig-align='center' width=60%}\n:::\n:::\n\n\n## Estimated home random effects by team\n\n\n::: {.cell layout-align=\"center\"}\n::: {.cell-output-display}\n![](21-multilevel-glms-pt2_files/figure-revealjs/unnamed-chunk-18-1.png){fig-align='center' width=100%}\n:::\n:::\n\n\n## Code \n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nvar <- attr(ranef(full_model)$hometeam, \"postVar\")\nreffect_predict <- tibble(Intercepts = reffect_home,\n              SD = 2*sqrt(var[,,1:length(var)]),\n              team_names = reffect_team$team)\n\nggplot(data = reffect_predict, aes(fct_reorder(team_names, Intercepts), \n                                   Intercepts)) + \n  geom_point() + \n  geom_hline(yintercept = 0) + \n  geom_errorbar(aes(ymin = Intercepts - SD,\n                    ymax = Intercepts + SD),\n                width=0,color=\"black\") + \n  labs(title = \"Estimated random home team effects\", \n       x = \"Home teams\", \n       y = \"Estimated random effects\") + \n theme(axis.text.y = element_text(size = 7)) + \n  coord_flip()\n```\n:::\n\n\n## References\n",
    "supporting": [
      "21-multilevel-glms-pt2_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {
      "include-after-body": [
        "\n<script>\n  // htmlwidgets need to know to resize themselves when slides are shown/hidden.\n  // Fire the \"slideenter\" event (handled by htmlwidgets.js) when the current\n  // slide changes (different for each slide format).\n  (function () {\n    // dispatch for htmlwidgets\n    function fireSlideEnter() {\n      const event = window.document.createEvent(\"Event\");\n      event.initEvent(\"slideenter\", true, true);\n      window.document.dispatchEvent(event);\n    }\n\n    function fireSlideChanged(previousSlide, currentSlide) {\n      fireSlideEnter();\n\n      // dispatch for shiny\n      if (window.jQuery) {\n        if (previousSlide) {\n          window.jQuery(previousSlide).trigger(\"hidden\");\n        }\n        if (currentSlide) {\n          window.jQuery(currentSlide).trigger(\"shown\");\n        }\n      }\n    }\n\n    // hookup for slidy\n    if (window.w3c_slidy) {\n      window.w3c_slidy.add_observer(function (slide_num) {\n        // slide_num starts at position 1\n        fireSlideChanged(null, w3c_slidy.slides[slide_num - 1]);\n      });\n    }\n\n  })();\n</script>\n\n"
      ]
    },
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}